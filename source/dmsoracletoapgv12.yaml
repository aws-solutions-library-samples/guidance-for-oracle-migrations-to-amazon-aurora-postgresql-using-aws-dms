AWSTemplateFormatVersion: 2010-09-09
Description: "Cloudformation template for DMS"

Parameters:
  VPCCIDR:
    Type: String
    Description: VPC CIDR to deploy the resources
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/(1[6-9]|2[0-8]))$
    ConstraintDescription: must be a valid IP CIDR range of the form x.x.x.x/x.
    Default: "10.0.0.0/16"
  PrivateSubnet1CIDR:
    Type: String
    Description: Private Subnet one to deploy the Oracle and Aurora PostgreSQL cluster
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/(1[6-9]|2[0-8]))$
    ConstraintDescription: must be a valid IP CIDR range of the form x.x.x.x/x.
    Default: "10.0.0.0/20"
  PrivateSubnet2CIDR:
    Type: String
    Description: Private Subnet two to deploy the Oracle and Aurora PostgreSQL cluster
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/(1[6-9]|2[0-8]))$
    ConstraintDescription: must be a valid IP CIDR range of the form x.x.x.x/x.
    Default: "10.0.16.0/20"
  PublicSubnet1CIDR:
    Type: String
    Description: Public Subnet one to deploy the EC2 instance to connect to the Oracle and Aurora PostgreSQL cluster
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/(1[6-9]|2[0-8]))$
    ConstraintDescription: must be a valid IP CIDR range of the form x.x.x.x/x.
    Default: "10.0.128.0/20"
  DoesVPCRoleExist:
    Type: String
    Description: If the IAM role dms-vpc-role already exists, select "True". Selecting "False" will create the IAM role.
    AllowedValues: 
      - Yes
      - No
    Default: Yes
  DoesDMSCloudWatchLogsRoleExist:
    Type: String
    Description: If the IAM role dms-cloudwatch-logs-role already exists, select "True". Selecting "False" will create the IAM role.
    AllowedValues: 
      - Yes
      - No
    Default: Yes
  OracleInsatnceClass:
    Type: String
    Default: db.r6i.16xlarge
    Description: Select the approprtiate instance class for the RDS Oracle Instance
    AllowedValues:
          - db.m5.12xlarge
          - db.m5.12xlarge
          - db.m5.12xlarge
          - db.m5.12xlarge
          - db.m5.12xlarge
          - db.m5.16xlarge
          - db.m5.16xlarge
          - db.m5.16xlarge
          - db.m5.16xlarge
          - db.m5.16xlarge
          - db.m5.24xlarge
          - db.m5.24xlarge
          - db.m5.24xlarge
          - db.m5.24xlarge
          - db.m5.24xlarge
          - db.m5.2xlarge
          - db.m5.2xlarge
          - db.m5.2xlarge
          - db.m5.2xlarge
          - db.m5.2xlarge
          - db.m5.4xlarge
          - db.m5.4xlarge
          - db.m5.4xlarge
          - db.m5.4xlarge
          - db.m5.4xlarge
          - db.m5.8xlarge
          - db.m5.8xlarge
          - db.m5.8xlarge
          - db.m5.8xlarge
          - db.m5.8xlarge
          - db.m5d.12xlarge
          - db.m5d.12xlarge
          - db.m5d.12xlarge
          - db.m5d.12xlarge
          - db.m5d.12xlarge
          - db.m5d.16xlarge
          - db.m5d.16xlarge
          - db.m5d.16xlarge
          - db.m5d.16xlarge
          - db.m5d.16xlarge
          - db.m5d.24xlarge
          - db.m5d.24xlarge
          - db.m5d.24xlarge
          - db.m5d.24xlarge
          - db.m5d.24xlarge
          - db.m5d.2xlarge
          - db.m5d.2xlarge
          - db.m5d.2xlarge
          - db.m5d.2xlarge
          - db.m5d.2xlarge
          - db.m5d.4xlarge
          - db.m5d.4xlarge
          - db.m5d.4xlarge
          - db.m5d.4xlarge
          - db.m5d.4xlarge
          - db.m5d.8xlarge
          - db.m5d.8xlarge
          - db.m5d.8xlarge
          - db.m5d.8xlarge
          - db.m5d.8xlarge
          - db.m5d.large
          - db.m5d.large
          - db.m5d.large
          - db.m5d.large
          - db.m5d.large
          - db.m5d.xlarge
          - db.m5d.xlarge
          - db.m5d.xlarge
          - db.m5d.xlarge
          - db.m5d.xlarge
          - db.m5.large
          - db.m5.large
          - db.m5.large
          - db.m5.large
          - db.m5.large
          - db.m5.xlarge
          - db.m5.xlarge
          - db.m5.xlarge
          - db.m5.xlarge
          - db.m5.xlarge
          - db.m6i.12xlarge
          - db.m6i.12xlarge
          - db.m6i.12xlarge
          - db.m6i.12xlarge
          - db.m6i.12xlarge
          - db.m6i.16xlarge
          - db.m6i.16xlarge
          - db.m6i.16xlarge
          - db.m6i.16xlarge
          - db.m6i.16xlarge
          - db.m6i.24xlarge
          - db.m6i.24xlarge
          - db.m6i.24xlarge
          - db.m6i.24xlarge
          - db.m6i.24xlarge
          - db.m6i.2xlarge
          - db.m6i.2xlarge
          - db.m6i.2xlarge
          - db.m6i.2xlarge
          - db.m6i.2xlarge
          - db.m6i.32xlarge
          - db.m6i.32xlarge
          - db.m6i.32xlarge
          - db.m6i.32xlarge
          - db.m6i.32xlarge
          - db.m6i.4xlarge
          - db.m6i.4xlarge
          - db.m6i.4xlarge
          - db.m6i.4xlarge
          - db.m6i.4xlarge
          - db.m6i.8xlarge
          - db.m6i.8xlarge
          - db.m6i.8xlarge
          - db.m6i.8xlarge
          - db.m6i.8xlarge
          - db.m6i.large
          - db.m6i.large
          - db.m6i.large
          - db.m6i.large
          - db.m6i.large
          - db.m6i.xlarge
          - db.m6i.xlarge
          - db.m6i.xlarge
          - db.m6i.xlarge
          - db.m6i.xlarge
          - db.r5.12xlarge
          - db.r5.12xlarge
          - db.r5.12xlarge
          - db.r5.12xlarge
          - db.r5.12xlarge
          - db.r5.12xlarge.tpc2.mem2x
          - db.r5.12xlarge.tpc2.mem2x
          - db.r5.12xlarge.tpc2.mem2x
          - db.r5.12xlarge.tpc2.mem2x
          - db.r5.12xlarge.tpc2.mem2x
          - db.r5.16xlarge
          - db.r5.16xlarge
          - db.r5.16xlarge
          - db.r5.16xlarge
          - db.r5.16xlarge
          - db.r5.24xlarge
          - db.r5.24xlarge
          - db.r5.24xlarge
          - db.r5.24xlarge
          - db.r5.24xlarge
          - db.r5.2xlarge
          - db.r5.2xlarge
          - db.r5.2xlarge
          - db.r5.2xlarge
          - db.r5.2xlarge
          - db.r5.2xlarge.tpc1.mem2x
          - db.r5.2xlarge.tpc1.mem2x
          - db.r5.2xlarge.tpc1.mem2x
          - db.r5.2xlarge.tpc1.mem2x
          - db.r5.2xlarge.tpc1.mem2x
          - db.r5.2xlarge.tpc2.mem4x
          - db.r5.2xlarge.tpc2.mem4x
          - db.r5.2xlarge.tpc2.mem4x
          - db.r5.2xlarge.tpc2.mem4x
          - db.r5.2xlarge.tpc2.mem4x
          - db.r5.2xlarge.tpc2.mem8x
          - db.r5.2xlarge.tpc2.mem8x
          - db.r5.2xlarge.tpc2.mem8x
          - db.r5.2xlarge.tpc2.mem8x
          - db.r5.2xlarge.tpc2.mem8x
          - db.r5.4xlarge
          - db.r5.4xlarge
          - db.r5.4xlarge
          - db.r5.4xlarge
          - db.r5.4xlarge
          - db.r5.4xlarge.tpc2.mem2x
          - db.r5.4xlarge.tpc2.mem2x
          - db.r5.4xlarge.tpc2.mem2x
          - db.r5.4xlarge.tpc2.mem2x
          - db.r5.4xlarge.tpc2.mem2x
          - db.r5.4xlarge.tpc2.mem3x
          - db.r5.4xlarge.tpc2.mem3x
          - db.r5.4xlarge.tpc2.mem3x
          - db.r5.4xlarge.tpc2.mem3x
          - db.r5.4xlarge.tpc2.mem3x
          - db.r5.4xlarge.tpc2.mem4x
          - db.r5.4xlarge.tpc2.mem4x
          - db.r5.4xlarge.tpc2.mem4x
          - db.r5.4xlarge.tpc2.mem4x
          - db.r5.4xlarge.tpc2.mem4x
          - db.r5.6xlarge.tpc2.mem4x
          - db.r5.6xlarge.tpc2.mem4x
          - db.r5.6xlarge.tpc2.mem4x
          - db.r5.6xlarge.tpc2.mem4x
          - db.r5.6xlarge.tpc2.mem4x
          - db.r5.8xlarge
          - db.r5.8xlarge
          - db.r5.8xlarge
          - db.r5.8xlarge
          - db.r5.8xlarge
          - db.r5.8xlarge.tpc2.mem3x
          - db.r5.8xlarge.tpc2.mem3x
          - db.r5.8xlarge.tpc2.mem3x
          - db.r5.8xlarge.tpc2.mem3x
          - db.r5.8xlarge.tpc2.mem3x
          - db.r5b.12xlarge
          - db.r5b.12xlarge
          - db.r5b.12xlarge
          - db.r5b.12xlarge
          - db.r5b.12xlarge
          - db.r5b.16xlarge
          - db.r5b.16xlarge
          - db.r5b.16xlarge
          - db.r5b.16xlarge
          - db.r5b.16xlarge
          - db.r5b.24xlarge
          - db.r5b.24xlarge
          - db.r5b.24xlarge
          - db.r5b.24xlarge
          - db.r5b.24xlarge
          - db.r5b.2xlarge
          - db.r5b.2xlarge
          - db.r5b.2xlarge
          - db.r5b.2xlarge
          - db.r5b.2xlarge
          - db.r5b.2xlarge.tpc1.mem2x
          - db.r5b.2xlarge.tpc1.mem2x
          - db.r5b.2xlarge.tpc1.mem2x
          - db.r5b.2xlarge.tpc1.mem2x
          - db.r5b.2xlarge.tpc1.mem2x
          - db.r5b.2xlarge.tpc2.mem4x
          - db.r5b.2xlarge.tpc2.mem4x
          - db.r5b.2xlarge.tpc2.mem4x
          - db.r5b.2xlarge.tpc2.mem4x
          - db.r5b.2xlarge.tpc2.mem4x
          - db.r5b.2xlarge.tpc2.mem8x
          - db.r5b.2xlarge.tpc2.mem8x
          - db.r5b.2xlarge.tpc2.mem8x
          - db.r5b.2xlarge.tpc2.mem8x
          - db.r5b.2xlarge.tpc2.mem8x
          - db.r5b.4xlarge
          - db.r5b.4xlarge
          - db.r5b.4xlarge
          - db.r5b.4xlarge
          - db.r5b.4xlarge
          - db.r5b.4xlarge.tpc2.mem2x
          - db.r5b.4xlarge.tpc2.mem2x
          - db.r5b.4xlarge.tpc2.mem2x
          - db.r5b.4xlarge.tpc2.mem2x
          - db.r5b.4xlarge.tpc2.mem2x
          - db.r5b.4xlarge.tpc2.mem3x
          - db.r5b.4xlarge.tpc2.mem3x
          - db.r5b.4xlarge.tpc2.mem3x
          - db.r5b.4xlarge.tpc2.mem3x
          - db.r5b.4xlarge.tpc2.mem3x
          - db.r5b.4xlarge.tpc2.mem4x
          - db.r5b.4xlarge.tpc2.mem4x
          - db.r5b.4xlarge.tpc2.mem4x
          - db.r5b.4xlarge.tpc2.mem4x
          - db.r5b.4xlarge.tpc2.mem4x
          - db.r5b.6xlarge.tpc2.mem4x
          - db.r5b.6xlarge.tpc2.mem4x
          - db.r5b.6xlarge.tpc2.mem4x
          - db.r5b.6xlarge.tpc2.mem4x
          - db.r5b.6xlarge.tpc2.mem4x
          - db.r5b.8xlarge
          - db.r5b.8xlarge
          - db.r5b.8xlarge
          - db.r5b.8xlarge
          - db.r5b.8xlarge
          - db.r5b.8xlarge.tpc2.mem3x
          - db.r5b.8xlarge.tpc2.mem3x
          - db.r5b.8xlarge.tpc2.mem3x
          - db.r5b.8xlarge.tpc2.mem3x
          - db.r5b.8xlarge.tpc2.mem3x
          - db.r5b.large
          - db.r5b.large
          - db.r5b.large
          - db.r5b.large
          - db.r5b.large
          - db.r5b.large.tpc1.mem2x
          - db.r5b.large.tpc1.mem2x
          - db.r5b.large.tpc1.mem2x
          - db.r5b.large.tpc1.mem2x
          - db.r5b.large.tpc1.mem2x
          - db.r5b.xlarge
          - db.r5b.xlarge
          - db.r5b.xlarge
          - db.r5b.xlarge
          - db.r5b.xlarge
          - db.r5b.xlarge.tpc2.mem2x
          - db.r5b.xlarge.tpc2.mem2x
          - db.r5b.xlarge.tpc2.mem2x
          - db.r5b.xlarge.tpc2.mem2x
          - db.r5b.xlarge.tpc2.mem2x
          - db.r5b.xlarge.tpc2.mem4x
          - db.r5b.xlarge.tpc2.mem4x
          - db.r5b.xlarge.tpc2.mem4x
          - db.r5b.xlarge.tpc2.mem4x
          - db.r5b.xlarge.tpc2.mem4x
          - db.r5d.12xlarge
          - db.r5d.12xlarge
          - db.r5d.12xlarge
          - db.r5d.12xlarge
          - db.r5d.12xlarge
          - db.r5d.16xlarge
          - db.r5d.16xlarge
          - db.r5d.16xlarge
          - db.r5d.16xlarge
          - db.r5d.16xlarge
          - db.r5d.24xlarge
          - db.r5d.24xlarge
          - db.r5d.24xlarge
          - db.r5d.24xlarge
          - db.r5d.24xlarge
          - db.r5d.2xlarge
          - db.r5d.2xlarge
          - db.r5d.2xlarge
          - db.r5d.2xlarge
          - db.r5d.2xlarge
          - db.r5d.4xlarge
          - db.r5d.4xlarge
          - db.r5d.4xlarge
          - db.r5d.4xlarge
          - db.r5d.4xlarge
          - db.r5d.8xlarge
          - db.r5d.8xlarge
          - db.r5d.8xlarge
          - db.r5d.8xlarge
          - db.r5d.8xlarge
          - db.r5d.large
          - db.r5d.large
          - db.r5d.large
          - db.r5d.large
          - db.r5d.large
          - db.r5d.xlarge
          - db.r5d.xlarge
          - db.r5d.xlarge
          - db.r5d.xlarge
          - db.r5d.xlarge
          - db.r5.large
          - db.r5.large
          - db.r5.large
          - db.r5.large
          - db.r5.large
          - db.r5.large.tpc1.mem2x
          - db.r5.large.tpc1.mem2x
          - db.r5.large.tpc1.mem2x
          - db.r5.large.tpc1.mem2x
          - db.r5.large.tpc1.mem2x
          - db.r5.xlarge
          - db.r5.xlarge
          - db.r5.xlarge
          - db.r5.xlarge
          - db.r5.xlarge
          - db.r5.xlarge.tpc2.mem2x
          - db.r5.xlarge.tpc2.mem2x
          - db.r5.xlarge.tpc2.mem2x
          - db.r5.xlarge.tpc2.mem2x
          - db.r5.xlarge.tpc2.mem2x
          - db.r5.xlarge.tpc2.mem4x
          - db.r5.xlarge.tpc2.mem4x
          - db.r5.xlarge.tpc2.mem4x
          - db.r5.xlarge.tpc2.mem4x
          - db.r5.xlarge.tpc2.mem4x
          - db.r6i.12xlarge
          - db.r6i.12xlarge
          - db.r6i.12xlarge
          - db.r6i.12xlarge
          - db.r6i.12xlarge
          - db.r6i.16xlarge
          - db.r6i.16xlarge
          - db.r6i.16xlarge
          - db.r6i.16xlarge
          - db.r6i.16xlarge
          - db.r6i.24xlarge
          - db.r6i.24xlarge
          - db.r6i.24xlarge
          - db.r6i.24xlarge
          - db.r6i.24xlarge
          - db.r6i.2xlarge
          - db.r6i.2xlarge
          - db.r6i.2xlarge
          - db.r6i.2xlarge
          - db.r6i.2xlarge
          - db.r6i.32xlarge
          - db.r6i.32xlarge
          - db.r6i.32xlarge
          - db.r6i.32xlarge
          - db.r6i.32xlarge
          - db.r6i.4xlarge
          - db.r6i.4xlarge
          - db.r6i.4xlarge
          - db.r6i.4xlarge
          - db.r6i.4xlarge
          - db.r6i.8xlarge
          - db.r6i.8xlarge
          - db.r6i.8xlarge
          - db.r6i.8xlarge
          - db.r6i.8xlarge
          - db.r6i.large
          - db.r6i.large
          - db.r6i.large
          - db.r6i.large
          - db.r6i.large
          - db.r6i.xlarge
          - db.r6i.xlarge
          - db.r6i.xlarge
          - db.r6i.xlarge
          - db.r6i.xlarge
          - db.t3.2xlarge
          - db.t3.2xlarge
          - db.t3.2xlarge
          - db.t3.2xlarge
          - db.t3.2xlarge
          - db.t3.large
          - db.t3.large
          - db.t3.large
          - db.t3.large
          - db.t3.large
          - db.t3.medium
          - db.t3.medium
          - db.t3.medium
          - db.t3.medium
          - db.t3.medium
          - db.t3.small
          - db.t3.small
          - db.t3.small
          - db.t3.small
          - db.t3.small
          - db.t3.xlarge
          - db.t3.xlarge
          - db.t3.xlarge
          - db.t3.xlarge
          - db.t3.xlarge
          - db.x1.16xlarge
          - db.x1.16xlarge
          - db.x1.16xlarge
          - db.x1.16xlarge
          - db.x1.16xlarge
          - db.x1.32xlarge
          - db.x1.32xlarge
          - db.x1.32xlarge
          - db.x1.32xlarge
          - db.x1.32xlarge
          - db.x1e.16xlarge
          - db.x1e.16xlarge
          - db.x1e.16xlarge
          - db.x1e.16xlarge
          - db.x1e.16xlarge
          - db.x1e.2xlarge
          - db.x1e.2xlarge
          - db.x1e.2xlarge
          - db.x1e.2xlarge
          - db.x1e.2xlarge
          - db.x1e.32xlarge
          - db.x1e.32xlarge
          - db.x1e.32xlarge
          - db.x1e.32xlarge
          - db.x1e.32xlarge
          - db.x1e.4xlarge
          - db.x1e.4xlarge
          - db.x1e.4xlarge
          - db.x1e.4xlarge
          - db.x1e.4xlarge
          - db.x1e.8xlarge
          - db.x1e.8xlarge
          - db.x1e.8xlarge
          - db.x1e.8xlarge
          - db.x1e.8xlarge
          - db.x1e.xlarge
          - db.x1e.xlarge
          - db.x1e.xlarge
          - db.x1e.xlarge
          - db.x1e.xlarge
          - db.x2idn.16xlarge
          - db.x2idn.16xlarge
          - db.x2idn.16xlarge
          - db.x2idn.16xlarge
          - db.x2idn.16xlarge
          - db.x2idn.24xlarge
          - db.x2idn.24xlarge
          - db.x2idn.24xlarge
          - db.x2idn.24xlarge
          - db.x2idn.24xlarge
          - db.x2idn.32xlarge
          - db.x2idn.32xlarge
          - db.x2idn.32xlarge
          - db.x2idn.32xlarge
          - db.x2idn.32xlarge
          - db.x2iedn.16xlarge
          - db.x2iedn.16xlarge
          - db.x2iedn.16xlarge
          - db.x2iedn.16xlarge
          - db.x2iedn.16xlarge
          - db.x2iedn.24xlarge
          - db.x2iedn.24xlarge
          - db.x2iedn.24xlarge
          - db.x2iedn.24xlarge
          - db.x2iedn.24xlarge
          - db.x2iedn.2xlarge
          - db.x2iedn.2xlarge
          - db.x2iedn.2xlarge
          - db.x2iedn.2xlarge
          - db.x2iedn.2xlarge
          - db.x2iedn.32xlarge
          - db.x2iedn.32xlarge
          - db.x2iedn.32xlarge
          - db.x2iedn.32xlarge
          - db.x2iedn.32xlarge
          - db.x2iedn.4xlarge
          - db.x2iedn.4xlarge
          - db.x2iedn.4xlarge
          - db.x2iedn.4xlarge
          - db.x2iedn.4xlarge
          - db.x2iedn.8xlarge
          - db.x2iedn.8xlarge
          - db.x2iedn.8xlarge
          - db.x2iedn.8xlarge
          - db.x2iedn.8xlarge
          - db.x2iedn.xlarge
          - db.x2iedn.xlarge
          - db.x2iedn.xlarge
          - db.x2iedn.xlarge
          - db.x2iedn.xlarge
          - db.z1d.12xlarge
          - db.z1d.12xlarge
          - db.z1d.12xlarge
          - db.z1d.12xlarge
          - db.z1d.12xlarge
          - db.z1d.2xlarge
          - db.z1d.2xlarge
          - db.z1d.2xlarge
          - db.z1d.2xlarge
          - db.z1d.2xlarge
          - db.z1d.3xlarge
          - db.z1d.3xlarge
          - db.z1d.3xlarge
          - db.z1d.3xlarge
          - db.z1d.3xlarge
          - db.z1d.6xlarge
          - db.z1d.6xlarge
          - db.z1d.6xlarge
          - db.z1d.6xlarge
          - db.z1d.6xlarge
          - db.z1d.large
          - db.z1d.large
          - db.z1d.large
          - db.z1d.large
          - db.z1d.large
          - db.z1d.xlarge
          - db.z1d.xlarge
          - db.z1d.xlarge
          - db.z1d.xlarge
          - db.z1d.xlarge
  AuroraPostgreSQLClusterClass:
    Type: String
    Default: db.r6g.16xlarge
    Description: Select the appropriate instance class for the Aurora PostgreSQL Cluster
    AllowedValues:
          - db.r5.12xlarge
          - db.r5.12xlarge
          - db.r5.16xlarge
          - db.r5.16xlarge
          - db.r5.24xlarge
          - db.r5.24xlarge
          - db.r5.2xlarge
          - db.r5.2xlarge
          - db.r5.4xlarge
          - db.r5.4xlarge
          - db.r5.8xlarge
          - db.r5.8xlarge
          - db.r5.large
          - db.r5.large
          - db.r5.xlarge
          - db.r5.xlarge
          - db.r6g.12xlarge
          - db.r6g.12xlarge
          - db.r6g.16xlarge
          - db.r6g.16xlarge
          - db.r6g.2xlarge
          - db.r6g.2xlarge
          - db.r6g.4xlarge
          - db.r6g.4xlarge
          - db.r6g.8xlarge
          - db.r6g.8xlarge
          - db.r6gd.12xlarge
          - db.r6gd.12xlarge
          - db.r6gd.16xlarge
          - db.r6gd.16xlarge
          - db.r6gd.2xlarge
          - db.r6gd.2xlarge
          - db.r6gd.4xlarge
          - db.r6gd.4xlarge
          - db.r6gd.8xlarge
          - db.r6gd.8xlarge
          - db.r6gd.xlarge
          - db.r6gd.xlarge
          - db.r6g.large
          - db.r6g.large
          - db.r6g.xlarge
          - db.r6g.xlarge
          - db.r6i.12xlarge
          - db.r6i.12xlarge
          - db.r6i.16xlarge
          - db.r6i.16xlarge
          - db.r6i.24xlarge
          - db.r6i.24xlarge
          - db.r6i.2xlarge
          - db.r6i.2xlarge
          - db.r6i.32xlarge
          - db.r6i.32xlarge
          - db.r6i.4xlarge
          - db.r6i.4xlarge
          - db.r6i.8xlarge
          - db.r6i.8xlarge
          - db.r6id.24xlarge
          - db.r6id.24xlarge
          - db.r6id.32xlarge
          - db.r6id.32xlarge
          - db.r6i.large
          - db.r6i.large
          - db.r6i.xlarge
          - db.r6i.xlarge
          - db.r7g.12xlarge
          - db.r7g.12xlarge
          - db.r7g.16xlarge
          - db.r7g.16xlarge
          - db.r7g.2xlarge
          - db.r7g.2xlarge
          - db.r7g.4xlarge
          - db.r7g.4xlarge
          - db.r7g.8xlarge
          - db.r7g.8xlarge
          - db.r7g.large
          - db.r7g.large
          - db.r7g.xlarge
          - db.r7g.xlarge
          - db.serverless
          - db.serverless
          - db.t3.large
          - db.t3.large
          - db.t3.medium
          - db.t3.medium
          - db.t4g.large
          - db.t4g.large
          - db.t4g.medium
          - db.t4g.medium
          - db.x2g.12xlarge
          - db.x2g.12xlarge
          - db.x2g.16xlarge
          - db.x2g.16xlarge
          - db.x2g.2xlarge
          - db.x2g.2xlarge
          - db.x2g.4xlarge
          - db.x2g.4xlarge
          - db.x2g.8xlarge
          - db.x2g.8xlarge
          - db.x2g.large
          - db.x2g.large
          - db.x2g.xlarge
          - db.x2g.xlarge
  DMSReplicationInstanceClass:
    Type: String
    Default: dms.r6i.16xlarge
    Description: Select the appropriate instance class for the DMS Replication Instance
    AllowedValues:
        - dms.c4.2xlarge
        - dms.c4.2xlarge
        - dms.c4.4xlarge
        - dms.c4.4xlarge
        - dms.c4.large
        - dms.c4.large
        - dms.c4.xlarge
        - dms.c4.xlarge
        - dms.c5.12xlarge
        - dms.c5.12xlarge
        - dms.c5.18xlarge
        - dms.c5.18xlarge
        - dms.c5.24xlarge
        - dms.c5.24xlarge
        - dms.c5.2xlarge
        - dms.c5.2xlarge
        - dms.c5.4xlarge
        - dms.c5.4xlarge
        - dms.c5.9xlarge
        - dms.c5.9xlarge
        - dms.c5.large
        - dms.c5.large
        - dms.c5.xlarge
        - dms.c5.xlarge
        - dms.c6i.12xlarge
        - dms.c6i.12xlarge
        - dms.c6i.16xlarge
        - dms.c6i.16xlarge
        - dms.c6i.24xlarge
        - dms.c6i.24xlarge
        - dms.c6i.2xlarge
        - dms.c6i.2xlarge
        - dms.c6i.32xlarge
        - dms.c6i.32xlarge
        - dms.c6i.4xlarge
        - dms.c6i.4xlarge
        - dms.c6i.8xlarge
        - dms.c6i.8xlarge
        - dms.c6i.large
        - dms.c6i.large
        - dms.c6i.xlarge
        - dms.c6i.xlarge
        - dms.r4.2xlarge
        - dms.r4.2xlarge
        - dms.r4.4xlarge
        - dms.r4.4xlarge
        - dms.r4.8xlarge
        - dms.r4.8xlarge
        - dms.r4.large
        - dms.r4.large
        - dms.r4.xlarge
        - dms.r4.xlarge
        - dms.r5.12xlarge
        - dms.r5.12xlarge
        - dms.r5.16xlarge
        - dms.r5.16xlarge
        - dms.r5.24xlarge
        - dms.r5.24xlarge
        - dms.r5.2xlarge
        - dms.r5.2xlarge
        - dms.r5.4xlarge
        - dms.r5.4xlarge
        - dms.r5.8xlarge
        - dms.r5.8xlarge
        - dms.r5.large
        - dms.r5.large
        - dms.r5.xlarge
        - dms.r5.xlarge
        - dms.r6i.12xlarge
        - dms.r6i.12xlarge
        - dms.r6i.16xlarge
        - dms.r6i.16xlarge
        - dms.r6i.24xlarge
        - dms.r6i.24xlarge
        - dms.r6i.2xlarge
        - dms.r6i.2xlarge
        - dms.r6i.32xlarge
        - dms.r6i.32xlarge
        - dms.r6i.4xlarge
        - dms.r6i.4xlarge
        - dms.r6i.8xlarge
        - dms.r6i.8xlarge
        - dms.r6i.large
        - dms.r6i.large
        - dms.r6i.xlarge
        - dms.r6i.xlarge
        - dms.t2.large
        - dms.t2.large
        - dms.t2.medium
        - dms.t2.medium
        - dms.t2.micro
        - dms.t2.micro
        - dms.t2.small
        - dms.t2.small
        - dms.t3.large
        - dms.t3.large
        - dms.t3.medium
        - dms.t3.medium
        - dms.t3.micro
        - dms.t3.micro
        - dms.t3.small
        - dms.t3.small
        - dms.c4.2xlarge
        - dms.c4.2xlarge
        - dms.c4.4xlarge
        - dms.c4.4xlarge
        - dms.c4.large
        - dms.c4.large
        - dms.c4.xlarge
        - dms.c4.xlarge
        - dms.c5.12xlarge
        - dms.c5.12xlarge
        - dms.c5.18xlarge
        - dms.c5.18xlarge
        - dms.c5.24xlarge
        - dms.c5.24xlarge
        - dms.c5.2xlarge
        - dms.c5.2xlarge
        - dms.c5.4xlarge
        - dms.c5.4xlarge
        - dms.c5.9xlarge
        - dms.c5.9xlarge
        - dms.c5.large
        - dms.c5.large
        - dms.c5.xlarge
        - dms.c5.xlarge
        - dms.c6i.12xlarge
        - dms.c6i.12xlarge
        - dms.c6i.16xlarge
        - dms.c6i.16xlarge
        - dms.c6i.24xlarge
        - dms.c6i.24xlarge
        - dms.c6i.2xlarge
        - dms.c6i.2xlarge
        - dms.c6i.32xlarge
        - dms.c6i.32xlarge
        - dms.c6i.4xlarge
        - dms.c6i.4xlarge
        - dms.c6i.8xlarge
        - dms.c6i.8xlarge
        - dms.c6i.large
        - dms.c6i.large
        - dms.c6i.xlarge
        - dms.c6i.xlarge
        - dms.r4.2xlarge
        - dms.r4.2xlarge
        - dms.r4.4xlarge
        - dms.r4.4xlarge
        - dms.r4.8xlarge
        - dms.r4.8xlarge
        - dms.r4.large
        - dms.r4.large
        - dms.r4.xlarge
        - dms.r4.xlarge
        - dms.r5.12xlarge
        - dms.r5.12xlarge
        - dms.r5.16xlarge
        - dms.r5.16xlarge
        - dms.r5.24xlarge
        - dms.r5.24xlarge
        - dms.r5.2xlarge
        - dms.r5.2xlarge
        - dms.r5.4xlarge
        - dms.r5.4xlarge
        - dms.r5.8xlarge
        - dms.r5.8xlarge
        - dms.r5.large
        - dms.r5.large
        - dms.r5.xlarge
        - dms.r5.xlarge
        - dms.r6i.12xlarge
        - dms.r6i.12xlarge
        - dms.r6i.16xlarge
        - dms.r6i.16xlarge
        - dms.r6i.24xlarge
        - dms.r6i.24xlarge
        - dms.r6i.2xlarge
        - dms.r6i.2xlarge
        - dms.r6i.32xlarge
        - dms.r6i.32xlarge
        - dms.r6i.4xlarge
        - dms.r6i.4xlarge
        - dms.r6i.8xlarge
        - dms.r6i.8xlarge
        - dms.r6i.large
        - dms.r6i.large
        - dms.r6i.xlarge
        - dms.r6i.xlarge
        - dms.t2.large
        - dms.t2.large
        - dms.t2.medium
        - dms.t2.medium
        - dms.t2.micro
        - dms.t2.micro
        - dms.t2.small
        - dms.t2.small
        - dms.t3.large
        - dms.t3.large
        - dms.t3.medium
        - dms.t3.medium
        - dms.t3.micro
        - dms.t3.micro
        - dms.t3.small
        - dms.t3.small
        - dms.c4.2xlarge
        - dms.c4.2xlarge
        - dms.c4.4xlarge
        - dms.c4.4xlarge
        - dms.c4.large
        - dms.c4.large
        - dms.c4.xlarge
        - dms.c4.xlarge
        - dms.c5.12xlarge
        - dms.c5.12xlarge
        - dms.c5.18xlarge
        - dms.c5.18xlarge
        - dms.c5.24xlarge
        - dms.c5.24xlarge
        - dms.c5.2xlarge
        - dms.c5.2xlarge
        - dms.c5.4xlarge
        - dms.c5.4xlarge
        - dms.c5.9xlarge
        - dms.c5.9xlarge
        - dms.c5.large
        - dms.c5.large
        - dms.c5.xlarge
        - dms.c5.xlarge
        - dms.c6i.12xlarge
        - dms.c6i.12xlarge
        - dms.c6i.16xlarge
        - dms.c6i.16xlarge
        - dms.c6i.24xlarge
        - dms.c6i.24xlarge
        - dms.c6i.2xlarge
        - dms.c6i.2xlarge
        - dms.c6i.32xlarge
        - dms.c6i.32xlarge
        - dms.c6i.4xlarge
        - dms.c6i.4xlarge
        - dms.c6i.8xlarge
        - dms.c6i.8xlarge
        - dms.c6i.large
        - dms.c6i.large
        - dms.c6i.xlarge
        - dms.c6i.xlarge
        - dms.r4.2xlarge
        - dms.r4.2xlarge
        - dms.r4.4xlarge
        - dms.r4.4xlarge
        - dms.r4.8xlarge
        - dms.r4.8xlarge
        - dms.r4.large
        - dms.r4.large
        - dms.r4.xlarge
        - dms.r4.xlarge
        - dms.r5.12xlarge
        - dms.r5.12xlarge
        - dms.r5.16xlarge
        - dms.r5.16xlarge
        - dms.r5.24xlarge
        - dms.r5.24xlarge
        - dms.r5.2xlarge
        - dms.r5.2xlarge
        - dms.r5.4xlarge
        - dms.r5.4xlarge
        - dms.r5.8xlarge
        - dms.r5.8xlarge
        - dms.r5.large
        - dms.r5.large
        - dms.r5.xlarge
        - dms.r5.xlarge
        - dms.r6i.12xlarge
        - dms.r6i.12xlarge
        - dms.r6i.16xlarge
        - dms.r6i.16xlarge
        - dms.r6i.24xlarge
        - dms.r6i.24xlarge
        - dms.r6i.2xlarge
        - dms.r6i.2xlarge
        - dms.r6i.32xlarge
        - dms.r6i.32xlarge
        - dms.r6i.4xlarge
        - dms.r6i.4xlarge
        - dms.r6i.8xlarge
        - dms.r6i.8xlarge
        - dms.r6i.large
        - dms.r6i.large
        - dms.r6i.xlarge
        - dms.r6i.xlarge
        - dms.t2.large
        - dms.t2.large
        - dms.t2.medium
        - dms.t2.medium
        - dms.t2.micro
        - dms.t2.micro
        - dms.t2.small
        - dms.t2.small
        - dms.t3.large
        - dms.t3.large
        - dms.t3.medium
        - dms.t3.medium
        - dms.t3.micro
        - dms.t3.micro
        - dms.t3.small
        - dms.t3.small
        - dms.c4.2xlarge
        - dms.c4.2xlarge
        - dms.c4.4xlarge
        - dms.c4.4xlarge
        - dms.c4.large
        - dms.c4.large
        - dms.c4.xlarge
        - dms.c4.xlarge
        - dms.c5.12xlarge
        - dms.c5.12xlarge
        - dms.c5.18xlarge
        - dms.c5.18xlarge
        - dms.c5.24xlarge
        - dms.c5.24xlarge
        - dms.c5.2xlarge
        - dms.c5.2xlarge
        - dms.c5.4xlarge
        - dms.c5.4xlarge
        - dms.c5.9xlarge
        - dms.c5.9xlarge
        - dms.c5.large
        - dms.c5.large
        - dms.c5.xlarge
        - dms.c5.xlarge
        - dms.c6i.12xlarge
        - dms.c6i.12xlarge
        - dms.c6i.16xlarge
        - dms.c6i.16xlarge
        - dms.c6i.24xlarge
        - dms.c6i.24xlarge
        - dms.c6i.2xlarge
        - dms.c6i.2xlarge
        - dms.c6i.32xlarge
        - dms.c6i.32xlarge
        - dms.c6i.4xlarge
        - dms.c6i.4xlarge
        - dms.c6i.8xlarge
        - dms.c6i.8xlarge
        - dms.c6i.large
        - dms.c6i.large
        - dms.c6i.xlarge
        - dms.c6i.xlarge
        - dms.r4.2xlarge
        - dms.r4.2xlarge
        - dms.r4.4xlarge
        - dms.r4.4xlarge
        - dms.r4.8xlarge
        - dms.r4.8xlarge
        - dms.r4.large
        - dms.r4.large
        - dms.r4.xlarge
        - dms.r4.xlarge
        - dms.r5.12xlarge
        - dms.r5.12xlarge
        - dms.r5.16xlarge
        - dms.r5.16xlarge
        - dms.r5.24xlarge
        - dms.r5.24xlarge
        - dms.r5.2xlarge
        - dms.r5.2xlarge
        - dms.r5.4xlarge
        - dms.r5.4xlarge
        - dms.r5.8xlarge
        - dms.r5.8xlarge
        - dms.r5.large
        - dms.r5.large
        - dms.r5.xlarge
        - dms.r5.xlarge
        - dms.r6i.12xlarge
        - dms.r6i.12xlarge
        - dms.r6i.16xlarge
        - dms.r6i.16xlarge
        - dms.r6i.24xlarge
        - dms.r6i.24xlarge
        - dms.r6i.2xlarge
        - dms.r6i.2xlarge
        - dms.r6i.32xlarge
        - dms.r6i.32xlarge
        - dms.r6i.4xlarge
        - dms.r6i.4xlarge
        - dms.r6i.8xlarge
        - dms.r6i.8xlarge
        - dms.r6i.large
        - dms.r6i.large
        - dms.r6i.xlarge
        - dms.r6i.xlarge
        - dms.t2.large
        - dms.t2.large
        - dms.t2.medium
        - dms.t2.medium
        - dms.t2.micro
        - dms.t2.micro
        - dms.t2.small
        - dms.t2.small
        - dms.t3.large
        - dms.t3.large
        - dms.t3.medium
        - dms.t3.medium
        - dms.t3.micro
        - dms.t3.micro
        - dms.t3.small
        - dms.t3.small
        - dms.c4.2xlarge
        - dms.c4.2xlarge
        - dms.c4.4xlarge
        - dms.c4.4xlarge
        - dms.c4.large
        - dms.c4.large
        - dms.c4.xlarge
        - dms.c4.xlarge
        - dms.c5.12xlarge
        - dms.c5.12xlarge
        - dms.c5.18xlarge
        - dms.c5.18xlarge
        - dms.c5.24xlarge
        - dms.c5.24xlarge
        - dms.c5.2xlarge
        - dms.c5.2xlarge
        - dms.c5.4xlarge
        - dms.c5.4xlarge
        - dms.c5.9xlarge
        - dms.c5.9xlarge
        - dms.c5.large
        - dms.c5.large
        - dms.c5.xlarge
        - dms.c5.xlarge
        - dms.c6i.12xlarge
        - dms.c6i.12xlarge
        - dms.c6i.16xlarge
        - dms.c6i.16xlarge
        - dms.c6i.24xlarge
        - dms.c6i.24xlarge
        - dms.c6i.2xlarge
        - dms.c6i.2xlarge
        - dms.c6i.32xlarge
        - dms.c6i.32xlarge
        - dms.c6i.4xlarge
        - dms.c6i.4xlarge
        - dms.c6i.8xlarge
        - dms.c6i.8xlarge
        - dms.c6i.large
        - dms.c6i.large
        - dms.c6i.xlarge
        - dms.c6i.xlarge
        - dms.r4.2xlarge
        - dms.r4.2xlarge
        - dms.r4.4xlarge
        - dms.r4.4xlarge
        - dms.r4.8xlarge
        - dms.r4.8xlarge
        - dms.r4.large
        - dms.r4.large
        - dms.r4.xlarge
        - dms.r4.xlarge
        - dms.r5.12xlarge
        - dms.r5.12xlarge
        - dms.r5.16xlarge
        - dms.r5.16xlarge
        - dms.r5.24xlarge
        - dms.r5.24xlarge
        - dms.r5.2xlarge
        - dms.r5.2xlarge
        - dms.r5.4xlarge
        - dms.r5.4xlarge
        - dms.r5.8xlarge
        - dms.r5.8xlarge
        - dms.r5.large
        - dms.r5.large
        - dms.r5.xlarge
        - dms.r5.xlarge
        - dms.r6i.12xlarge
        - dms.r6i.12xlarge
        - dms.r6i.16xlarge
        - dms.r6i.16xlarge
        - dms.r6i.24xlarge
        - dms.r6i.24xlarge
        - dms.r6i.2xlarge
        - dms.r6i.2xlarge
        - dms.r6i.32xlarge
        - dms.r6i.32xlarge
        - dms.r6i.4xlarge
        - dms.r6i.4xlarge
        - dms.r6i.8xlarge
        - dms.r6i.8xlarge
        - dms.r6i.large
        - dms.r6i.large
        - dms.r6i.xlarge
        - dms.r6i.xlarge
        - dms.t2.large
        - dms.t2.large
        - dms.t2.medium
        - dms.t2.medium
        - dms.t2.micro
        - dms.t2.micro
        - dms.t2.small
        - dms.t2.small
        - dms.t3.large
        - dms.t3.large
        - dms.t3.medium
        - dms.t3.medium
        - dms.t3.micro
        - dms.t3.micro
        - dms.t3.small
        - dms.t3.small         
  EC2InstanceClass:
    Type: String
    Default: m5.large
    Description: Select the appropriate instance class for the EC2 instance
    AllowedValues:
        - t3.nano
        - t2.nano
        - t3.micro
        - t2.small
        - t3.medium
        - t2.medium
        - t3.large
        - c5.large
        - t2.large
        - m4.large
        - c4.large
        - t3.xlarge
        - m5.large
        - m5.xlarge
        - c5.xlarge
        - t2.xlarge
        - m4.xlarge
        - c4.xlarge
        - t3.2xlarge
        - m5.2xlarge
        - c5.2xlarge
        - t2.2xlarge
        - m4.2xlarge
        - c4.2xlarge
        - m5.4xlarge
        - c5.4xlarge
        - m4.4xlarge
        - c4.4xlarge
        - m5.8xlarge
        - c4.8xlarge
        - c5.9xlarge
        - m4.10xlarge
        - m5.12xlarge
        - c5.12xlarge
        - m5.16xlarge
        - m4.16xlarge
        - c5.18xlarge
        - m5.24xlarge
        - m5.metal
        - c5.24xlarge

  LatestLinuxAMIId:
    Type: 'AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>'
    Default: '/aws/service/ami-amazon-linux-latest/al2023-ami-minimal-kernel-default-x86_64'      
        
Metadata: 
  AWS::CloudFormation::Interface: 
    ParameterGroups: 
      - 
        Label: 
          default: "VPC Configuration"
        Parameters: 
          - VPCCIDR
          - PrivateSubnet1CIDR
          - PrivateSubnet2CIDR
          - PublicSubnet1CIDR
      - 
        Label: 
          default: "DMS IAM Roles"
        Parameters: 
          - DoesVPCRoleExist
          - DoesDMSCloudWatchLogsRoleExist

      - 
        Label: 
          default: "Instance Class Configuration"
        Parameters: 
          - OracleInsatnceClass
          - AuroraPostgreSQLClusterClass
          - EC2InstanceClass
          - DMSReplicationInstanceClass  


    ParameterLabels: 
      VPCCIDR:
        default: "Provide the Details of the VPC in which you would like to deploy your resources"
      DoesVPCRoleExist:
        default: "DMS requires certain IAM roles. Please choose the appropriate option"
      OracleInsatnceClass:
        default: "Selecting the instance class for the below resources"

Conditions:
  
  VPCroleExists: !Equals [!Ref DoesVPCRoleExist, No]
  CloudWatchLogsRoleExists: !Equals [!Ref DoesDMSCloudWatchLogsRoleExist, No]
  
Resources:

#Create Oracle instance and DMS Source Endpoint

  OracleSecret:
    Type: AWS::SecretsManager::Secret
    Properties: 
      Name: !Sub ${AWS::StackName}-${AWS::Region}/dms-source-endpoint/oraclerds   
      Description: This is a Secrets Manager secret for Oracle Source Instance
      GenerateSecretString:
        SecretStringTemplate: '{"username": "admin"}'
        GenerateStringKey: "password"
        PasswordLength: 16
        ExcludeCharacters: "!\"#$%&'()*+,-./:;<=>@[\\]^_`{|}~"

  OracleSourceInstance:
    Type: AWS::RDS::DBInstance
    Properties:      
      AllocatedStorage: 5000
      DBInstanceClass: !Ref OracleInsatnceClass
      DBSubnetGroupName: !Ref RDSOracleSubnetGroup
      VPCSecurityGroups:
        - !Ref SecurityGroup
      Engine: oracle-ee
      DBName: dms
      EnablePerformanceInsights: true
      AssociatedRoles:
           - FeatureName: S3_INTEGRATION
             RoleArn: !GetAtt rdss3integrationIAMRole.Arn
      OptionGroupName: !Ref RDSOracleOptionGroup
      StorageEncrypted: true
      MaxAllocatedStorage: 5000
      MonitoringInterval: 1
      MonitoringRoleArn: !GetAtt EnhancedMonitoringIAMRole.Arn
      MasterUserPassword: !Sub '{{resolve:secretsmanager:${OracleSecret}::password}}'
      MasterUsername:  !Sub '{{resolve:secretsmanager:${OracleSecret}::username}}'
      LicenseModel: bring-your-own-license
      PubliclyAccessible: false
      DBParameterGroupName: !Ref RDSOracleInstanceParameterGroup
      StorageType: io2
      Iops: 30000
      Port: 1521
      DeletionProtection: True
  
  RDSOracleOptionGroup:
    Type: AWS::RDS::OptionGroup
    Properties:
         OptionGroupDescription: rds-oracle-option-group
         EngineName: oracle-ee
         MajorEngineVersion: 19
         OptionConfigurations:
          - OptionName: S3_INTEGRATION

  RDSOracleInstanceParameterGroup:
    Type: AWS::RDS::DBParameterGroup
    Properties:
      DBParameterGroupName: !Sub ${AWS::StackName}-${AWS::Region}-rds-oracle-source-pg
      Description: rds-oracle-source-pg
      Family: oracle-ee-19
      Parameters:
        job_queue_processes: 48

  RDSOracleSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: Subnet Group for Oracle RDS instance
      SubnetIds:
        - !Ref PrivateSubnet1
        - !Ref PrivateSubnet2

  OracleSourceEndpoint:
    Type: AWS::DMS::Endpoint
    Properties:
        EndpointIdentifier: !Sub ${AWS::StackName}-${AWS::Region}-oracle-source-endpoint
        EndpointType: "source"
        EngineName: "oracle"
        Password: !Sub '{{resolve:secretsmanager:${OracleSecret}::password}}'
        Port: 1521
        ServerName: !GetAtt OracleSourceInstance.Endpoint.Address
        Username: !Sub '{{resolve:secretsmanager:${OracleSecret}::username}}'
        DatabaseName: dms
        OracleSettings:
             UseLogminerReader: false
             UseBFile: true
             AddSupplementalLogging: true
      

#Create AuroraPostgreSQL Cluster and DMS Target Endpoint

  AuroraPostgreSQLTargetCluster:
    Type: AWS::RDS::DBCluster
    Properties:
      DatabaseName: dmsdb               
      MasterUsername:
        !Sub '{{resolve:secretsmanager:${AuroraPostgreSQLTargetSecret}::username}}'
      MasterUserPassword:
        !Sub '{{resolve:secretsmanager:${AuroraPostgreSQLTargetSecret}::password}}'      
      VpcSecurityGroupIds:
        - !Ref SecurityGroup
      StorageEncrypted: true
      PerformanceInsightsEnabled: true
      MonitoringInterval: 1
      MonitoringRoleArn: !GetAtt  EnhancedMonitoringIAMRole.Arn
      Engine: aurora-postgresql
      EngineVersion: "16.1"
      DBSubnetGroupName: !Ref AuroraPostgreSQLTargetSubnetGroup
      EnableCloudwatchLogsExports:
        - postgresql
      Port: 5432
      
  
  AuroraPostgreSQLTargetInstance1:
    Type: AWS::RDS::DBInstance
    Properties:
      DBClusterIdentifier: !Ref AuroraPostgreSQLTargetCluster      
      PubliclyAccessible: false
      Engine: aurora-postgresql
      DBInstanceClass: !Ref AuroraPostgreSQLClusterClass  
      EngineVersion: "16.1" 
      DBSubnetGroupName: !Ref AuroraPostgreSQLTargetSubnetGroup
  

  AuroraPostgreSQLTargetSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
         DBSubnetGroupDescription: Subnet Group for Aurora PostgreSQL cluster
         SubnetIds:
              - !Ref PrivateSubnet1
              - !Ref PrivateSubnet2
  
  AuroraPostgreSQLTargetSecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Sub ${AWS::StackName}-${AWS::Region}/dms-target-endpoint/apgsecret
      Description: This is a Secrets Manager secret for Aurora PostgreSQL cluster
      GenerateSecretString:
        SecretStringTemplate: '{"username": "postgres"}'
        GenerateStringKey: password
        PasswordLength: 16
        ExcludeCharacters: "!\"#$%&'()*+,-./:;<=>@[\\]^_`{|}~"
  
  SecretAuroraPostgreSQLTargetAttachment:
    Type: AWS::SecretsManager::SecretTargetAttachment
    Properties:
      SecretId:
        Ref: AuroraPostgreSQLTargetSecret
      TargetId:
        Ref: AuroraPostgreSQLTargetCluster
      TargetType: AWS::RDS::DBCluster
  

    
  DMSAuroraPostgreSQLTargetEndpoint:
    Type: AWS::DMS::Endpoint
    Properties:
      EndpointIdentifier: !Sub ${AWS::StackName}-${AWS::Region}-AuroraPostgreSQL-Target-Endpoint
      EndpointType: target
      EngineName: aurora-postgresql
      Password: !Sub '{{resolve:secretsmanager:${AuroraPostgreSQLTargetSecret}::password}}'
      Port: 5432
      ServerName: !GetAtt AuroraPostgreSQLTargetCluster.Endpoint.Address
      Username: !Sub '{{resolve:secretsmanager:${AuroraPostgreSQLTargetSecret}::username}}'
      DatabaseName: dmsdb
      PostgreSqlSettings:
           AfterConnectScript: "SET session_replication_role = replica"
           MaxFileSize: 512000

#Create Linux Instance to connect to the Oracle and PostgreSQL instance
 
  LinuxEC2Instance:    
    Type: AWS::EC2::Instance
    Metadata:
      AWS::CloudFormation::Init:
        config:
          packages:
            yum:
              wget: []
              dnf: []
          groups:
            dmsusers: {}         
          users:
            dms:
              groups:
                - "dmsusers"
              homeDir: "/home/dms"
          files:
            /home/dms/oracle.sql:
              content: |
                exec rdsadmin.rdsadmin_util.set_configuration('archivelog retention hours',24);
                exec rdsadmin.rdsadmin_util.alter_supplemental_logging('ADD');
                exec rdsadmin.rdsadmin_master_util.create_archivelog_dir; 
                exec rdsadmin.rdsadmin_master_util.create_onlinelog_dir;
              mode: "000644"
              owner: dms
              group: dmsusers
            /home/dms/export_variables.sh:
                content: !Sub |
                  #! /bin/bash
                  echo "export SOURCEDBUSER=$(aws secretsmanager get-secret-value  --secret-id ${AWS::StackName}-${AWS::Region}/dms-source-endpoint/oraclerds --query 'SecretString' --output text | jq .username | tr -d '"')" >> ~/.bashrc
                  echo "export SOURCEDBHOST=$(aws cloudformation describe-stacks --stack-name ${AWS::StackName} --output text --query "Stacks[][].Outputs[?OutputKey=='RDSOracleSourceInstance'].OutputValue")" >> ~/.bashrc
                  echo "export SOURCEDBPASSWORD=$(aws secretsmanager get-secret-value  --secret-id ${AWS::StackName}-${AWS::Region}/dms-source-endpoint/oraclerds --query 'SecretString' --output text | jq .password | tr -d '"')"  >> ~/.bashrc 
                  echo "export TARGETDBUSER=$(aws secretsmanager get-secret-value  --secret-id ${AWS::StackName}-${AWS::Region}/dms-target-endpoint/apgsecret --query 'SecretString' --output text | jq .username | tr -d '"')" >> ~/.bashrc
                  echo "export TARGETDBHOST=$(aws secretsmanager get-secret-value  --secret-id ${AWS::StackName}-${AWS::Region}/dms-target-endpoint/apgsecret --query 'SecretString' --output text | jq .host | tr -d '"')" >> ~/.bashrc
                  echo "export TARGETDBPASSWORD=$(aws secretsmanager get-secret-value  --secret-id ${AWS::StackName}-${AWS::Region}/dms-target-endpoint/apgsecret --query 'SecretString' --output text | jq .password | tr -d '"')" >> ~/.bashrc                 
                mode: "000644"
                owner: dms
                group: dmsusers
            /home/dms/oracle_prerequisites_dms.sh:
                content: |
                  #! /bin/bash
                  sqlplus ${SOURCEDBUSER}/${SOURCEDBPASSWORD}@${SOURCEDBHOST}:1521/DMS @oracle.sql
                mode: "000644"
                owner: dms
                group: dmsusers
            /home/dms/oracle_diagnostic_scripts.sh:
                content: |
                  #! /bin/bash
                  sqlplus ${SOURCEDBUSER}/${SOURCEDBPASSWORD}@${SOURCEDBHOST}:1521/DMS @awsdms_support_collector_oracle.sql
                mode: "000644"
                owner: dms
                group: dmsusers
            /home/dms/oracle_connect.sh:
                content: |
                  #! /bin/bash
                  sqlplus ${SOURCEDBUSER}/${SOURCEDBPASSWORD}@${SOURCEDBHOST}:1521/DMS
                mode: "000644"
                owner: dms
                group: dmsusers
            /home/dms/psql_connect.sh:
                content: |
                  #! /bin/bash
                  export PGPASSWORD=$TARGETDBPASSWORD
                  psql --host=${TARGETDBHOST} --port=5432 --dbname=postgres --username=${TARGETDBUSER}
                mode: "000644"
                owner: dms
                group: dmsusers
            /home/dms/export_report.sh:
                content: !Sub |
                  #! /bin/bash
                  aws s3 cp /home/dms/dms_support* s3://bucket-${AWS::AccountId}-${AWS::Region}-dms/
                mode: "000644"
                owner: dms
                group: dmsusers
            
          commands:
            downloadoraclediagnosticscript:
              command: |
                wget https://d2pwp9zz55emqw.cloudfront.net/scripts/awsdms_support_collector_oracle.sql
              cwd: "/home/dms/"
              ignoreErrors: true
            installoracleclient:
              command: |
                wget https://download.oracle.com/otn_software/linux/instantclient/219000/oracle-instantclient-basic-21.9.0.0.0-1.el8.x86_64.rpm
                wget https://download.oracle.com/otn_software/linux/instantclient/219000/oracle-instantclient-sqlplus-21.9.0.0.0-1.el8.x86_64.rpm
                sudo dnf install oracle-instantclient-*.rpm -y
              cwd: "~"
              ignoreErrors: true
            installpsql:
              command: 
                sudo dnf install postgresql15 -y
              cwd: "~"
              ignoreErrors: true           
    CreationPolicy:
      ResourceSignal:
        Timeout: PT10M 
    Properties:
      ImageId: !Ref LatestLinuxAMIId
      InstanceType: !Ref EC2InstanceClass  
      Tags:
      - Key : "Name"
        Value: !Sub "${AWS::StackName}-${AWS::Region}-EC2-dms"
      IamInstanceProfile: !Ref EC2InstanceProfile
      NetworkInterfaces:
       - AssociatePublicIpAddress: false
         SubnetId: !Ref PrivateSubnet1
         DeviceIndex: 0
         GroupSet: 
          - Ref: SecurityGroup
      UserData:
        Fn::Base64:
          !Sub |
            #!/bin/bash -xe
            yum update -y
            #install SSM Agent
            yum install -y https://s3.amazonaws.com/ec2-downloads-windows/SSMAgent/latest/linux_amd64/amazon-ssm-agent.rpm
            #install cfn-init
            yum install -y aws-cfn-bootstrap
            # initiate cfn-init
            /opt/aws/bin/cfn-init -v --stack ${AWS::StackName} --resource LinuxEC2Instance --region ${AWS::Region}
            # send signal of completion for cfn-init 
            /opt/aws/bin/cfn-signal -e $? --stack ${AWS::StackName} --resource LinuxEC2Instance --region ${AWS::Region}
         
#Create IAM resources for DMS

  MSVPCRole:
    Type: 'AWS::IAM::Role'
    Condition: VPCroleExists
    Properties:
      RoleName: 'dms-vpc-role'
      AssumeRolePolicyDocument:
        Statement:
          - Principal:
              Service: 'dms.amazonaws.com'
            Action:
              - 'sts:AssumeRole'
            Effect: Allow
      Path: /
      ManagedPolicyArns:
        - 'arn:aws:iam::aws:policy/service-role/AmazonDMSVPCManagementRole'
    
  DMSCloudWatchLogsRole:
    Type: 'AWS::IAM::Role'
    Condition: CloudWatchLogsRoleExists
    Properties:
      RoleName: 'dms-cloudwatch-logs-role'
      AssumeRolePolicyDocument:
        Statement:
          - Principal:
              Service: 'dms.amazonaws.com'
            Action:
              - 'sts:AssumeRole'
            Effect: Allow
      Path: /
      ManagedPolicyArns:
        - 'arn:aws:iam::aws:policy/service-role/AmazonDMSCloudWatchLogsRole' 


        

#Create IAM resource for AWS RDS instance 

  EnhancedMonitoringIAMRole:
    Type: 'AWS::IAM::Role'
    Properties:
      RoleName: !Sub ${AWS::StackName}-${AWS::Region}-emaccess
      AssumeRolePolicyDocument:
        Statement:
          - Principal:
              Service: 'monitoring.rds.amazonaws.com'
            Action:
              - 'sts:AssumeRole'
            Effect: Allow
      Path: /
      ManagedPolicyArns:
        - 'arn:aws:iam::aws:policy/service-role/AmazonRDSEnhancedMonitoringRole'

  rdss3integrationIAMRole:
    Type: 'AWS::IAM::Role'
    Properties:
      RoleName: !Sub ${AWS::StackName}-${AWS::Region}-rds-s3-integration-role
      AssumeRolePolicyDocument:
        Statement:
            - Principal:
                Service: 'rds.amazonaws.com'
              Action:
                - 'sts:AssumeRole'
              Effect: Allow
      Path: /
      Policies:
        - PolicyName: !Sub ${AWS::StackName}-${AWS::Region}-rds-s3-integration-policy
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              Action:
                - 's3:PutObject'
                - 's3:GetObject'
                - 's3:ListBucket'
                - 's3:DeleteObject'
                - 's3:PutObjectAcl'
              Effect: Allow
              Resource: 
                - !Sub 'arn:aws:s3:::bucket-${AWS::AccountId}-${AWS::Region}-dms-premigration'
                - !Sub 'arn:aws:s3:::bucket-${AWS::AccountId}-${AWS::Region}-dms-premigration/*'
       

#Create IAM resource for AWS EC2 instance

  EC2IAMRole:
    Type: 'AWS::IAM::Role'
    Properties:
      RoleName: !Sub ${AWS::StackName}-${AWS::Region}-ec2-role-to-access-resources
      AssumeRolePolicyDocument:
        Statement:
          - Principal:
              Service: 'ec2.amazonaws.com'
            Action:
              - 'sts:AssumeRole'
            Effect: Allow
      Path: /
      ManagedPolicyArns:
        - 'arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore'
        - 'arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy'
      Policies:
        - PolicyName: !Sub ${AWS::StackName}-${AWS::Region}-EC2permissionforS3export
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              Action:
                - 's3:PutObject'
                - 's3:DeleteObject'
                - 's3:GetObject'
                - 's3:PutObjectTagging'
                - 's3:ListBucket'
                - 's3:GetBucketLocation'
              Effect: Allow
              Resource: 
                - !Sub 'arn:aws:s3:::bucket-${AWS::AccountId}-${AWS::Region}-dms-premigration'
                - !Sub 'arn:aws:s3:::bucket-${AWS::AccountId}-${AWS::Region}-dms-premigration/*'
        - PolicyName: !Sub ${AWS::StackName}-${AWS::Region}-SecretsManagerRetrieval
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              Action:
                - 'secretsmanager:GetSecretValue'
              Effect: Allow
              Resource: 
                - !Sub 'arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${AWS::StackName}-${AWS::Region}/dms-source-endpoint/*'
                - !Sub 'arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${AWS::StackName}-${AWS::Region}/dms-target-endpoint/*'
        - PolicyName: !Sub ${AWS::StackName}-${AWS::Region}-CloudformationRetrieval
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              Action:
                - 'cloudformation:DescribeStacks'
              Effect: Allow
              Resource: 
                - !Sub 'arn:aws:cloudformation:${AWS::Region}:${AWS::AccountId}:stack/*'


  EC2InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles: 
         - !Ref EC2IAMRole

#Create resources for running DMS pre-migration assessment

  S3BucketDMS:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub bucket-${AWS::AccountId}-${AWS::Region}-dms

  DMSPremigrationAssessmentS3Role:
    Type: 'AWS::IAM::Role'
    Properties:
      RoleName: !Sub ${AWS::StackName}-${AWS::Region}-DMSPremigrationAssessmentS3Role
      AssumeRolePolicyDocument:
        Statement:
          - Principal:
              Service: 'dms.amazonaws.com'
            Action:
              - 'sts:AssumeRole'
            Effect: Allow
      Path: /
      Policies:
        - PolicyName: !Sub ${AWS::StackName}-${AWS::Region}-DMSPremigrationAssessmentS3Policy
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              Action:
                - 's3:PutObject'
                - 's3:DeleteObject'
                - 's3:GetObject'
                - 's3:PutObjectTagging'
                - 's3:ListBucket'
                - 's3:GetBucketLocation'
              Effect: Allow
              Resource: 
                - !Sub 'arn:aws:s3:::bucket-${AWS::AccountId}-${AWS::Region}-dms-premigration'
                - !Sub 'arn:aws:s3:::bucket-${AWS::AccountId}-${AWS::Region}-dms-premigration/*'

#Create DMS Resources

  DMSSubnetGroup:
    Type: AWS::DMS::ReplicationSubnetGroup
    Properties:
      ReplicationSubnetGroupDescription: "DMS Subnet SG"
      ReplicationSubnetGroupIdentifier: "dms-subnet"
      SubnetIds:
        - !Ref PrivateSubnet1
        - !Ref PrivateSubnet2

  DMSReplicationInstance:
    Type: AWS::DMS::ReplicationInstance
    Properties:
      ReplicationInstanceClass: !Ref DMSReplicationInstanceClass
      PubliclyAccessible: false 
      AllocatedStorage: 1000
      EngineVersion: 3.5.3
      ReplicationInstanceIdentifier: "dms-replication-instance"
      ReplicationSubnetGroupIdentifier: !Ref DMSSubnetGroup
      VpcSecurityGroupIds: 
        - !Ref SecurityGroup
  
    
  
  DMSReplicationTasksubpartitionsauto:
    Type: AWS::DMS::ReplicationTask
    Properties:
      MigrationType: "full-load-and-cdc"
      ReplicationInstanceArn: !Ref DMSReplicationInstance
      ReplicationTaskIdentifier: !Sub ${AWS::StackName}-${AWS::Region}-parallel-load-subpartitions-auto
      SourceEndpointArn: !Ref OracleSourceEndpoint
      TargetEndpointArn: !Ref DMSAuroraPostgreSQLTargetEndpoint
      ReplicationTaskSettings: '{
                          "TargetMetadata":
                          {
                              "TargetSchema": "",
                              "SupportLobs": true,
                              "FullLobMode": false,
                              "LobChunkSize": 64,
                              "LimitedSizeLobMode": true,
                              "LobMaxSize": 32,
                              "InlineLobMaxSize": 0,
                              "LoadMaxFileSize": 0,
                              "ParallelLoadThreads": 0,
                              "ParallelLoadBufferSize": 0,
                              "BatchApplyEnabled": false,
                              "TaskRecoveryTableEnabled": false,
                              "ParallelLoadQueuesPerThread": 0,
                              "ParallelApplyThreads": 0,
                              "ParallelApplyBufferSize": 0,
                              "ParallelApplyQueuesPerThread": 0
                          },
                          "FullLoadSettings":
                          {
                              "CreatePkAfterFullLoad": false,
                              "StopTaskCachedChangesApplied": false,
                              "StopTaskCachedChangesNotApplied": false,
                              "MaxFullLoadSubTasks": 32,
                              "TransactionConsistencyTimeout": 600,
                              "CommitRate": 10000
                          },
                          "Logging":
                          {
                              "EnableLogging": true,
                              "EnableLogContext": true,
                              "LogComponents":
                              [
                                  {
                                      "Id": "SOURCE_UNLOAD",
                                      "Severity": "LOGGER_SEVERITY_DEFAULT"
                                  },
                                  {
                                      "Id": "SOURCE_CAPTURE",
                                      "Severity": "LOGGER_SEVERITY_DEFAULT"
                                  },
                                  {
                                      "Id": "TARGET_LOAD",
                                      "Severity": "LOGGER_SEVERITY_DEFAULT"
                                  },
                                  {
                                      "Id": "TARGET_APPLY",
                                      "Severity": "LOGGER_SEVERITY_DEFAULT"
                                  },
                                  {
                                      "Id": "TASK_MANAGER",
                                      "Severity": "LOGGER_SEVERITY_DEFAULT"
                                  }
                              ],
                              "CloudWatchLogGroup": null,
                              "CloudWatchLogStream": null
                          },
                          "ControlTablesSettings":
                          {
                              "ControlSchema": "",
                              "HistoryTimeslotInMinutes": 5,
                              "HistoryTableEnabled": false,
                              "SuspendedTablesTableEnabled": false,
                              "StatusTableEnabled": false
                          },
                          "StreamBufferSettings":
                          {
                              "StreamBufferCount": 3,
                              "StreamBufferSizeInMB": 8,
                              "CtrlStreamBufferSizeInMB": 5
                          },
                          "ChangeProcessingDdlHandlingPolicy":
                          {
                              "HandleSourceTableDropped": true,
                              "HandleSourceTableTruncated": true,
                              "HandleSourceTableAltered": true
                          },
                          "ErrorBehavior":
                          {
                              "DataErrorPolicy": "LOG_ERROR",
                              "DataTruncationErrorPolicy": "LOG_ERROR",
                              "DataErrorEscalationPolicy": "SUSPEND_TABLE",
                              "DataErrorEscalationCount": 0,
                              "TableErrorPolicy": "SUSPEND_TABLE",
                              "TableErrorEscalationPolicy": "STOP_TASK",
                              "TableErrorEscalationCount": 0,
                              "RecoverableErrorCount": -1,
                              "RecoverableErrorInterval": 5,
                              "RecoverableErrorThrottling": true,
                              "RecoverableErrorThrottlingMax": 1800,
                              "RecoverableErrorStopRetryAfterThrottlingMax": false,
                              "ApplyErrorDeletePolicy": "IGNORE_RECORD",
                              "ApplyErrorInsertPolicy": "LOG_ERROR",
                              "ApplyErrorUpdatePolicy": "LOG_ERROR",
                              "ApplyErrorEscalationPolicy": "LOG_ERROR",
                              "ApplyErrorEscalationCount": 0,
                              "ApplyErrorFailOnTruncationDdl": false,
                              "FullLoadIgnoreConflicts": true,
                              "FailOnTransactionConsistencyBreached": false,
                              "FailOnNoTablesCaptured": false
                          },
                          "ChangeProcessingTuning":
                          {
                              "BatchApplyPreserveTransaction": true,
                              "BatchApplyTimeoutMin": 1,
                              "BatchApplyTimeoutMax": 30,
                              "BatchApplyMemoryLimit": 500,
                              "BatchSplitSize": 0,
                              "MinTransactionSize": 1000,
                              "CommitTimeout": 1,
                              "MemoryLimitTotal": 1024,
                              "MemoryKeepTime": 60,
                              "StatementCacheSize": 50
                          },
                          "ValidationSettings":
                          {
                              "EnableValidation": false,
                              "ValidationMode": "ROW_LEVEL",
                              "ThreadCount": 5,
                              "FailureMaxCount": 10000,
                              "TableFailureMaxCount": 1000,
                              "HandleCollationDiff": false,
                              "ValidationOnly": false,
                              "RecordFailureDelayLimitInMinutes": 0,
                              "SkipLobColumns": false,
                              "ValidationPartialLobSize": 0,
                              "ValidationQueryCdcDelaySeconds": 0,
                              "PartitionSize": 10000
                          },
                          "PostProcessingRules": null,
                          "CharacterSetSettings": null,
                          "LoopbackPreventionSettings": null,
                          "BeforeImageSettings": null
                      }'
      TableMappings: '{
    "rules":
    [
        {
            "rule-type": "transformation",
            "rule-id": "5",
            "rule-name": "5",
            "rule-target": "column",
            "object-locator":
            {
                "schema-name": "%",
                "table-name": "%",
                "column-name": "%"
            },
            "rule-action": "convert-lowercase",
            "value": null,
            "old-value": null
        },
        {
            "rule-type": "transformation",
            "rule-id": "4",
            "rule-name": "4",
            "rule-target": "table",
            "object-locator":
            {
                "schema-name": "%",
                "table-name": "%"
            },
            "rule-action": "convert-lowercase",
            "value": null,
            "old-value": null
        },
        {
            "rule-type": "transformation",
            "rule-id": "3",
            "rule-name": "3",
            "rule-target": "schema",
            "object-locator":
            {
                "schema-name": "%"
            },
            "rule-action": "convert-lowercase",
            "value": null,
            "old-value": null
        },
        {
            "rule-type": "selection",
            "rule-id": "1",
            "rule-name": "1",
            "object-locator":
            {
                "schema-name": "DMS_SAMPLE",
                "table-name": "EMPLOYEE_NEW_DATA"
            },
            "rule-action": "include",
            "filters":
            []
        },
        {
            "rule-type": "table-settings",
            "rule-id": "2",
            "rule-name": "2",
            "object-locator":
            {
                "schema-name": "DMS_SAMPLE",
                "table-name": "EMPLOYEE_NEW_DATA"
            },
            "parallel-load":
            {
                "type": "subpartitions-auto"
            }
        }
    ]
}'

  DMSReplicationTaskpartitionsauto:
    Type: AWS::DMS::ReplicationTask
    Properties:
      MigrationType: "full-load-and-cdc"
      ReplicationInstanceArn: !Ref DMSReplicationInstance
      ReplicationTaskIdentifier: !Sub ${AWS::StackName}-${AWS::Region}-parallel-load-partitions-auto
      SourceEndpointArn: !Ref OracleSourceEndpoint
      TargetEndpointArn: !Ref DMSAuroraPostgreSQLTargetEndpoint
      ReplicationTaskSettings: '{
                          "TargetMetadata":
                          {
                              "TargetSchema": "",
                              "SupportLobs": true,
                              "FullLobMode": false,
                              "LobChunkSize": 64,
                              "LimitedSizeLobMode": true,
                              "LobMaxSize": 32,
                              "InlineLobMaxSize": 0,
                              "LoadMaxFileSize": 0,
                              "ParallelLoadThreads": 0,
                              "ParallelLoadBufferSize": 0,
                              "BatchApplyEnabled": false,
                              "TaskRecoveryTableEnabled": false,
                              "ParallelLoadQueuesPerThread": 0,
                              "ParallelApplyThreads": 0,
                              "ParallelApplyBufferSize": 0,
                              "ParallelApplyQueuesPerThread": 0
                          },
                          "FullLoadSettings":
                          {
                              "CreatePkAfterFullLoad": false,
                              "StopTaskCachedChangesApplied": false,
                              "StopTaskCachedChangesNotApplied": false,
                              "MaxFullLoadSubTasks": 32,
                              "TransactionConsistencyTimeout": 600,
                              "CommitRate": 10000
                          },
                          "Logging":
                          {
                              "EnableLogging": true,
                              "EnableLogContext": true,
                              "LogComponents":
                              [
                                  {
                                      "Id": "SOURCE_UNLOAD",
                                      "Severity": "LOGGER_SEVERITY_DEFAULT"
                                  },
                                  {
                                      "Id": "SOURCE_CAPTURE",
                                      "Severity": "LOGGER_SEVERITY_DEFAULT"
                                  },
                                  {
                                      "Id": "TARGET_LOAD",
                                      "Severity": "LOGGER_SEVERITY_DEFAULT"
                                  },
                                  {
                                      "Id": "TARGET_APPLY",
                                      "Severity": "LOGGER_SEVERITY_DEFAULT"
                                  },
                                  {
                                      "Id": "TASK_MANAGER",
                                      "Severity": "LOGGER_SEVERITY_DEFAULT"
                                  }
                              ],
                              "CloudWatchLogGroup": null,
                              "CloudWatchLogStream": null
                          },
                          "ControlTablesSettings":
                          {
                              "ControlSchema": "",
                              "HistoryTimeslotInMinutes": 5,
                              "HistoryTableEnabled": false,
                              "SuspendedTablesTableEnabled": false,
                              "StatusTableEnabled": false
                          },
                          "StreamBufferSettings":
                          {
                              "StreamBufferCount": 3,
                              "StreamBufferSizeInMB": 8,
                              "CtrlStreamBufferSizeInMB": 5
                          },
                          "ChangeProcessingDdlHandlingPolicy":
                          {
                              "HandleSourceTableDropped": true,
                              "HandleSourceTableTruncated": true,
                              "HandleSourceTableAltered": true
                          },
                          "ErrorBehavior":
                          {
                              "DataErrorPolicy": "LOG_ERROR",
                              "DataTruncationErrorPolicy": "LOG_ERROR",
                              "DataErrorEscalationPolicy": "SUSPEND_TABLE",
                              "DataErrorEscalationCount": 0,
                              "TableErrorPolicy": "SUSPEND_TABLE",
                              "TableErrorEscalationPolicy": "STOP_TASK",
                              "TableErrorEscalationCount": 0,
                              "RecoverableErrorCount": -1,
                              "RecoverableErrorInterval": 5,
                              "RecoverableErrorThrottling": true,
                              "RecoverableErrorThrottlingMax": 1800,
                              "RecoverableErrorStopRetryAfterThrottlingMax": false,
                              "ApplyErrorDeletePolicy": "IGNORE_RECORD",
                              "ApplyErrorInsertPolicy": "LOG_ERROR",
                              "ApplyErrorUpdatePolicy": "LOG_ERROR",
                              "ApplyErrorEscalationPolicy": "LOG_ERROR",
                              "ApplyErrorEscalationCount": 0,
                              "ApplyErrorFailOnTruncationDdl": false,
                              "FullLoadIgnoreConflicts": true,
                              "FailOnTransactionConsistencyBreached": false,
                              "FailOnNoTablesCaptured": false
                          },
                          "ChangeProcessingTuning":
                          {
                              "BatchApplyPreserveTransaction": true,
                              "BatchApplyTimeoutMin": 1,
                              "BatchApplyTimeoutMax": 30,
                              "BatchApplyMemoryLimit": 500,
                              "BatchSplitSize": 0,
                              "MinTransactionSize": 1000,
                              "CommitTimeout": 1,
                              "MemoryLimitTotal": 1024,
                              "MemoryKeepTime": 60,
                              "StatementCacheSize": 50
                          },
                          "ValidationSettings":
                          {
                              "EnableValidation": false,
                              "ValidationMode": "ROW_LEVEL",
                              "ThreadCount": 5,
                              "FailureMaxCount": 10000,
                              "TableFailureMaxCount": 1000,
                              "HandleCollationDiff": false,
                              "ValidationOnly": false,
                              "RecordFailureDelayLimitInMinutes": 0,
                              "SkipLobColumns": false,
                              "ValidationPartialLobSize": 0,
                              "ValidationQueryCdcDelaySeconds": 0,
                              "PartitionSize": 10000
                          },
                          "PostProcessingRules": null,
                          "CharacterSetSettings": null,
                          "LoopbackPreventionSettings": null,
                          "BeforeImageSettings": null
                      }'
      TableMappings: '{
          "rules":
          [
              {
                  "rule-type": "transformation",
                  "rule-id": "1",
                  "rule-name": "1",
                  "rule-target": "column",
                  "object-locator":
                  {
                      "schema-name": "%",
                      "table-name": "%",
                      "column-name": "%"
                  },
                  "rule-action": "convert-lowercase",
                  "value": null,
                  "old-value": null
              },
              {
                  "rule-type": "transformation",
                  "rule-id": "2",
                  "rule-name": "2",
                  "rule-target": "table",
                  "object-locator":
                  {
                      "schema-name": "%",
                      "table-name": "%"
                  },
                  "rule-action": "convert-lowercase",
                  "value": null,
                  "old-value": null
              },
              {
                  "rule-type": "transformation",
                  "rule-id": "3",
                  "rule-name": "3",
                  "rule-target": "schema",
                  "object-locator":
                  {
                      "schema-name": "%"
                  },
                  "rule-action": "convert-lowercase",
                  "value": null,
                  "old-value": null
              },
              {
                  "rule-type": "selection",
                  "rule-id": "4",
                  "rule-name": "4",
                  "object-locator":
                  {
                      "schema-name": "DMS_SAMPLE",
                      "table-name": "PROJECT"
                  },
                  "rule-action": "include",
                  "filters":
                  []
              },
              {
                  "rule-type": "table-settings",
                  "rule-id": "5",
                  "rule-name": "5",
                  "object-locator":
                  {
                      "schema-name": "DMS_SAMPLE",
                      "table-name": "PROJECT"
                  },
                  "parallel-load":
                  {
                      "type": "partitions-auto"
                  }
              },
              {
                  "rule-type": "selection",
                  "rule-id": "6",
                  "rule-name": "6",
                  "object-locator":
                  {
                      "schema-name": "DMS_SAMPLE",
                      "table-name": "CUSTOMERORDERITEM"
                  },
                  "rule-action": "include",
                  "filters":
                  []
              },
              {
                  "rule-type": "table-settings",
                  "rule-id": "7",
                  "rule-name": "7",
                  "object-locator":
                  {
                      "schema-name": "DMS_SAMPLE",
                      "table-name": "CUSTOMERORDERITEM"
                  },
                  "parallel-load":
                  {
                      "type": "partitions-auto"
                  }
              },
              {
                  "rule-type": "selection",
                  "rule-id": "8",
                  "rule-name": "8",
                  "object-locator":
                  {
                      "schema-name": "DMS_SAMPLE",
                      "table-name": "ORDERPRODUCT"
                  },
                  "rule-action": "include",
                  "filters":
                  []
              },
              {
                  "rule-type": "table-settings",
                  "rule-id": "9",
                  "rule-name": "9",
                  "object-locator":
                  {
                      "schema-name": "DMS_SAMPLE",
                      "table-name": "ORDERPRODUCT"
                  },
                  "parallel-load":
                  {
                      "type": "partitions-auto"
                  }
              },
              {
                  "rule-type": "selection",
                  "rule-id": "10",
                  "rule-name": "10",
                  "object-locator":
                  {
                      "schema-name": "DMS_SAMPLE",
                      "table-name": "PURCHASEORDERITEM"
                  },
                  "rule-action": "include",
                  "filters":
                  []
              },
              {
                  "rule-type": "table-settings",
                  "rule-id": "11",
                  "rule-name": "11",
                  "object-locator":
                  {
                      "schema-name": "DMS_SAMPLE",
                      "table-name": "PURCHASEORDERITEM"
                  },
                  "parallel-load":
                  {
                      "type": "partitions-auto"
                  }
              },
              {
                  "rule-type": "selection",
                  "rule-id": "12",
                  "rule-name": "12",
                  "object-locator":
                  {
                      "schema-name": "DMS_SAMPLE",
                      "table-name": "SERVICEASSIGNMENT"
                  },
                  "rule-action": "include",
                  "filters":
                  []
              },
              {
                  "rule-type": "table-settings",
                  "rule-id": "13",
                  "rule-name": "13",
                  "object-locator":
                  {
                      "schema-name": "DMS_SAMPLE",
                      "table-name": "SERVICEASSIGNMENT"
                  },
                  "parallel-load":
                  {
                      "type": "partitions-auto"
                  }
              },
              {
                  "rule-type": "selection",
                  "rule-id": "14",
                  "rule-name": "14",
                  "object-locator":
                  {
                      "schema-name": "DMS_SAMPLE",
                      "table-name": "SHIPMENT"
                  },
                  "rule-action": "include",
                  "filters":
                  []
              },
              {
                  "rule-type": "table-settings",
                  "rule-id": "15",
                  "rule-name": "15",
                  "object-locator":
                  {
                      "schema-name": "DMS_SAMPLE",
                      "table-name": "SHIPMENT"
                  },
                  "parallel-load":
                  {
                      "type": "partitions-auto"
                  }
              },
              {
                  "rule-type": "selection",
                  "rule-id": "16",
                  "rule-name": "16",
                  "object-locator":
                  {
                      "schema-name": "DMS_SAMPLE",
                      "table-name": "PAYMENT"
                  },
                  "rule-action": "include",
                  "filters":
                  []
              },
              {
                  "rule-type": "table-settings",
                  "rule-id": "17",
                  "rule-name": "17",
                  "object-locator":
                  {
                      "schema-name": "DMS_SAMPLE",
                      "table-name": "PAYMENT"
                  },
                  "parallel-load":
                  {
                      "type": "partitions-auto"
                  }
              },
              {
                  "rule-type": "selection",
                  "rule-id": "18",
                  "rule-name": "18",
                  "object-locator":
                  {
                      "schema-name": "DMS_SAMPLE",
                      "table-name": "STOCKMOVEMENT"
                  },
                  "rule-action": "include",
                  "filters":
                  []
              },
              {
                  "rule-type": "table-settings",
                  "rule-id": "19",
                  "rule-name": "19",
                  "object-locator":
                  {
                      "schema-name": "DMS_SAMPLE",
                      "table-name": "STOCKMOVEMENT"
                  },
                  "parallel-load":
                  {
                      "type": "partitions-auto"
                  }
              },
              {
                  "rule-type": "selection",
                  "rule-id": "20",
                  "rule-name": "20",
                  "object-locator":
                  {
                      "schema-name": "DMS_SAMPLE",
                      "table-name": "PURCHASEORDER"
                  },
                  "rule-action": "include",
                  "filters":
                  []
              },
              {
                  "rule-type": "table-settings",
                  "rule-id": "21",
                  "rule-name": "21",
                  "object-locator":
                  {
                      "schema-name": "DMS_SAMPLE",
                      "table-name": "PURCHASEORDER"
                  },
                  "parallel-load":
                  {
                      "type": "partitions-auto"
                  }
              },
              {
                  "rule-type": "selection",
                  "rule-id": "22",
                  "rule-name": "22",
                  "object-locator":
                  {
                      "schema-name": "DMS_SAMPLE",
                      "table-name": "WARRANTY"
                  },
                  "rule-action": "include",
                  "filters":
                  []
              },
              {
                  "rule-type": "table-settings",
                  "rule-id": "23",
                  "rule-name": "23",
                  "object-locator":
                  {
                      "schema-name": "DMS_SAMPLE",
                      "table-name": "WARRANTY"
                  },
                  "parallel-load":
                  {
                      "type": "partitions-auto"
                  }
              },
              {
                  "rule-type": "selection",
                  "rule-id": "24",
                  "rule-name": "24",
                  "object-locator":
                  {
                      "schema-name": "DMS_SAMPLE",
                      "table-name": "CUSTOMER"
                  },
                  "rule-action": "include",
                  "filters":
                  []
              },
              {
                  "rule-type": "table-settings",
                  "rule-id": "25",
                  "rule-name": "25",
                  "object-locator":
                  {
                      "schema-name": "DMS_SAMPLE",
                      "table-name": "CUSTOMER"
                  },
                  "parallel-load":
                  {
                      "type": "partitions-auto"
                  }
              },
              {
                  "rule-type": "selection",
                  "rule-id": "26",
                  "rule-name": "26",
                  "object-locator":
                  {
                      "schema-name": "DMS_SAMPLE",
                      "table-name": "SALARY"
                  },
                  "rule-action": "include",
                  "filters":
                  []
              },
              {
                  "rule-type": "table-settings",
                  "rule-id": "27",
                  "rule-name": "27",
                  "object-locator":
                  {
                      "schema-name": "DMS_SAMPLE",
                      "table-name": "SALARY"
                  },
                  "parallel-load":
                  {
                      "type": "partitions-auto"
                  }
              },
              {
                  "rule-type": "selection",
                  "rule-id": "28",
                  "rule-name": "28",
                  "object-locator":
                  {
                      "schema-name": "DMS_SAMPLE",
                      "table-name": "INVOICE"
                  },
                  "rule-action": "include",
                  "filters":
                  []
              },
              {
                  "rule-type": "table-settings",
                  "rule-id": "29",
                  "rule-name": "29",
                  "object-locator":
                  {
                      "schema-name": "DMS_SAMPLE",
                      "table-name": "INVOICE"
                  },
                  "parallel-load":
                  {
                      "type": "partitions-auto"
                  }
              },
              {
                  "rule-type": "selection",
                  "rule-id": "30",
                  "rule-name": "30",
                  "object-locator":
                  {
                      "schema-name": "DMS_SAMPLE",
                      "table-name": "SERVICEREQUESTACTION"
                  },
                  "rule-action": "include",
                  "filters":
                  []
              },
              {
                  "rule-type": "table-settings",
                  "rule-id": "31",
                  "rule-name": "31",
                  "object-locator":
                  {
                      "schema-name": "DMS_SAMPLE",
                      "table-name": "SERVICEREQUESTACTION"
                  },
                  "parallel-load":
                  {
                      "type": "partitions-auto"
                  }
              },
              {
                  "rule-type": "selection",
                  "rule-id": "32",
                  "rule-name": "32",
                  "object-locator":
                  {
                      "schema-name": "DMS_SAMPLE",
                      "table-name": "INVENTORY"
                  },
                  "rule-action": "include",
                  "filters":
                  []
              },
              {
                  "rule-type": "table-settings",
                  "rule-id": "33",
                  "rule-name": "33",
                  "object-locator":
                  {
                      "schema-name": "DMS_SAMPLE",
                      "table-name": "INVENTORY"
                  },
                  "parallel-load":
                  {
                      "type": "partitions-auto"
                  }
              },
              {
                  "rule-type": "selection",
                  "rule-id": "34",
                  "rule-name": "34",
                  "object-locator":
                  {
                      "schema-name": "DMS_SAMPLE",
                      "table-name": "CUSTOMERORDER"
                  },
                  "rule-action": "include",
                  "filters":
                  []
              },
              {
                  "rule-type": "table-settings",
                  "rule-id": "35",
                  "rule-name": "35",
                  "object-locator":
                  {
                      "schema-name": "DMS_SAMPLE",
                      "table-name": "CUSTOMERORDER"
                  },
                  "parallel-load":
                  {
                      "type": "partitions-auto"
                  }
              },
              {
                  "rule-type": "selection",
                  "rule-id": "36",
                  "rule-name": "36",
                  "object-locator":
                  {
                      "schema-name": "DMS_SAMPLE",
                      "table-name": "PRODUCTRETURN"
                  },
                  "rule-action": "include",
                  "filters":
                  []
              },
              {
                  "rule-type": "table-settings",
                  "rule-id": "37",
                  "rule-name": "37",
                  "object-locator":
                  {
                      "schema-name": "DMS_SAMPLE",
                      "table-name": "PRODUCTRETURN"
                  },
                  "parallel-load":
                  {
                      "type": "partitions-auto"
                  }
              },
              {
                  "rule-type": "selection",
                  "rule-id": "38",
                  "rule-name": "38",
                  "object-locator":
                  {
                      "schema-name": "DMS_SAMPLE",
                      "table-name": "SERVICEREQUEST"
                  },
                  "rule-action": "include",
                  "filters":
                  []
              },
              {
                  "rule-type": "table-settings",
                  "rule-id": "39",
                  "rule-name": "39",
                  "object-locator":
                  {
                      "schema-name": "DMS_SAMPLE",
                      "table-name": "SERVICEREQUEST"
                  },
                  "parallel-load":
                  {
                      "type": "partitions-auto"
                  }
              },
              {
                  "rule-type": "selection",
                  "rule-id": "40",
                  "rule-name": "40",
                  "object-locator":
                  {
                      "schema-name": "DMS_SAMPLE",
                      "table-name": "ORDER"
                  },
                  "rule-action": "include",
                  "filters":
                  []
              },
              {
                  "rule-type": "table-settings",
                  "rule-id": "41",
                  "rule-name": "41",
                  "object-locator":
                  {
                      "schema-name": "DMS_SAMPLE",
                      "table-name": "ORDER"
                  },
                  "parallel-load":
                  {
                      "type": "partitions-auto"
                  }
              },
              {
                  "rule-type": "selection",
                  "rule-id": "42",
                  "rule-name": "42",
                  "object-locator":
                  {
                      "schema-name": "DMS_SAMPLE",
                      "table-name": "TIMESHEET"
                  },
                  "rule-action": "include",
                  "filters":
                  []
              },
              {
                  "rule-type": "table-settings",
                  "rule-id": "43",
                  "rule-name": "43",
                  "object-locator":
                  {
                      "schema-name": "DMS_SAMPLE",
                      "table-name": "TIMESHEET"
                  },
                  "parallel-load":
                  {
                      "type": "partitions-auto"
                  }
              }

          ]
      }'

  DMSReplicationTaskpartitionranges:
    Type: AWS::DMS::ReplicationTask
    Properties:
      MigrationType: "full-load-and-cdc"
      ReplicationInstanceArn: !Ref DMSReplicationInstance
      ReplicationTaskIdentifier: !Sub ${AWS::StackName}-${AWS::Region}-parallel-load-partitions-ranges
      SourceEndpointArn: !Ref OracleSourceEndpoint
      TargetEndpointArn: !Ref DMSAuroraPostgreSQLTargetEndpoint
      ReplicationTaskSettings: '{
                          "TargetMetadata":
                          {
                              "TargetSchema": "",
                              "SupportLobs": true,
                              "FullLobMode": false,
                              "LobChunkSize": 64,
                              "LimitedSizeLobMode": true,
                              "LobMaxSize": 32,
                              "InlineLobMaxSize": 0,
                              "LoadMaxFileSize": 0,
                              "ParallelLoadThreads": 0,
                              "ParallelLoadBufferSize": 0,
                              "BatchApplyEnabled": false,
                              "TaskRecoveryTableEnabled": false,
                              "ParallelLoadQueuesPerThread": 0,
                              "ParallelApplyThreads": 0,
                              "ParallelApplyBufferSize": 0,
                              "ParallelApplyQueuesPerThread": 0
                          },
                          "FullLoadSettings":
                          {
                              "CreatePkAfterFullLoad": false,
                              "StopTaskCachedChangesApplied": false,
                              "StopTaskCachedChangesNotApplied": false,
                              "MaxFullLoadSubTasks": 32,
                              "TransactionConsistencyTimeout": 600,
                              "CommitRate": 10000
                          },
                          "Logging":
                          {
                              "EnableLogging": true,
                              "EnableLogContext": true,
                              "LogComponents":
                              [
                                  {
                                      "Id": "SOURCE_UNLOAD",
                                      "Severity": "LOGGER_SEVERITY_DEFAULT"
                                  },
                                  {
                                      "Id": "SOURCE_CAPTURE",
                                      "Severity": "LOGGER_SEVERITY_DEFAULT"
                                  },
                                  {
                                      "Id": "TARGET_LOAD",
                                      "Severity": "LOGGER_SEVERITY_DEFAULT"
                                  },
                                  {
                                      "Id": "TARGET_APPLY",
                                      "Severity": "LOGGER_SEVERITY_DEFAULT"
                                  },
                                  {
                                      "Id": "TASK_MANAGER",
                                      "Severity": "LOGGER_SEVERITY_DEFAULT"
                                  }
                              ],
                              "CloudWatchLogGroup": null,
                              "CloudWatchLogStream": null
                          },
                          "ControlTablesSettings":
                          {
                              "ControlSchema": "",
                              "HistoryTimeslotInMinutes": 5,
                              "HistoryTableEnabled": false,
                              "SuspendedTablesTableEnabled": false,
                              "StatusTableEnabled": false
                          },
                          "StreamBufferSettings":
                          {
                              "StreamBufferCount": 3,
                              "StreamBufferSizeInMB": 8,
                              "CtrlStreamBufferSizeInMB": 5
                          },
                          "ChangeProcessingDdlHandlingPolicy":
                          {
                              "HandleSourceTableDropped": true,
                              "HandleSourceTableTruncated": true,
                              "HandleSourceTableAltered": true
                          },
                          "ErrorBehavior":
                          {
                              "DataErrorPolicy": "LOG_ERROR",
                              "DataTruncationErrorPolicy": "LOG_ERROR",
                              "DataErrorEscalationPolicy": "SUSPEND_TABLE",
                              "DataErrorEscalationCount": 0,
                              "TableErrorPolicy": "SUSPEND_TABLE",
                              "TableErrorEscalationPolicy": "STOP_TASK",
                              "TableErrorEscalationCount": 0,
                              "RecoverableErrorCount": -1,
                              "RecoverableErrorInterval": 5,
                              "RecoverableErrorThrottling": true,
                              "RecoverableErrorThrottlingMax": 1800,
                              "RecoverableErrorStopRetryAfterThrottlingMax": false,
                              "ApplyErrorDeletePolicy": "IGNORE_RECORD",
                              "ApplyErrorInsertPolicy": "LOG_ERROR",
                              "ApplyErrorUpdatePolicy": "LOG_ERROR",
                              "ApplyErrorEscalationPolicy": "LOG_ERROR",
                              "ApplyErrorEscalationCount": 0,
                              "ApplyErrorFailOnTruncationDdl": false,
                              "FullLoadIgnoreConflicts": true,
                              "FailOnTransactionConsistencyBreached": false,
                              "FailOnNoTablesCaptured": false
                          },
                          "ChangeProcessingTuning":
                          {
                              "BatchApplyPreserveTransaction": true,
                              "BatchApplyTimeoutMin": 1,
                              "BatchApplyTimeoutMax": 30,
                              "BatchApplyMemoryLimit": 500,
                              "BatchSplitSize": 0,
                              "MinTransactionSize": 1000,
                              "CommitTimeout": 1,
                              "MemoryLimitTotal": 1024,
                              "MemoryKeepTime": 60,
                              "StatementCacheSize": 50
                          },
                          "ValidationSettings":
                          {
                              "EnableValidation": false,
                              "ValidationMode": "ROW_LEVEL",
                              "ThreadCount": 5,
                              "FailureMaxCount": 10000,
                              "TableFailureMaxCount": 1000,
                              "HandleCollationDiff": false,
                              "ValidationOnly": false,
                              "RecordFailureDelayLimitInMinutes": 0,
                              "SkipLobColumns": false,
                              "ValidationPartialLobSize": 0,
                              "ValidationQueryCdcDelaySeconds": 0,
                              "PartitionSize": 10000
                          },
                          "PostProcessingRules": null,
                          "CharacterSetSettings": null,
                          "LoopbackPreventionSettings": null,
                          "BeforeImageSettings": null
                      }'
      TableMappings: '{
          "rules":
          [
              {
                  "rule-type": "transformation",
                  "rule-id": "1",
                  "rule-name": "1",
                  "rule-target": "column",
                  "object-locator":
                  {
                      "schema-name": "%",
                      "table-name": "%",
                      "column-name": "%"
                  },
                  "rule-action": "convert-lowercase",
                  "value": null,
                  "old-value": null
              },
              {
                  "rule-type": "transformation",
                  "rule-id": "2",
                  "rule-name": "2",
                  "rule-target": "table",
                  "object-locator":
                  {
                      "schema-name": "%",
                      "table-name": "%"
                  },
                  "rule-action": "convert-lowercase",
                  "value": null,
                  "old-value": null
              },
              {
                  "rule-type": "transformation",
                  "rule-id": "3",
                  "rule-name": "3",
                  "rule-target": "schema",
                  "object-locator":
                  {
                      "schema-name": "%"
                  },
                  "rule-action": "convert-lowercase",
                  "value": null,
                  "old-value": null
              },
              {
                  "rule-type": "selection",
                  "rule-id": "4",
                  "rule-name": "4",
                  "object-locator":
                  {
                      "schema-name": "DMS_SAMPLE",
                      "table-name": "EMPLOYEE"
                  },
                  "rule-action": "include",
                  "filters":
                  []
              },
              {
                  "rule-type": "table-settings",
                  "rule-id": "5",
                  "rule-name": "5",
                  "object-locator":
                  {
                      "schema-name": "DMS_SAMPLE",
                      "table-name": "EMPLOYEE"
                  },
                  "parallel-load":
                  {
                      "type": "ranges",
                      "columns": ["EMPLOYEEID"],
                      "boundaries":
                      [
                      [
                        "1176112"
                      ],
                      [
                        "2462980"
                      ],
                      [
                        "3665008"
                      ],
                      [
                        "4841119"
                      ],
                      [
                        "6034197"
                      ],
                      [
                        "7210308"
                      ],
                      [
                        "8402259"
                      ],
                      [
                        "9578369"
                      ],
                      [
                        "10754479"
                      ],
                      [
                        "11930589"
                      ],
                      [
                        "13106699"
                      ],
                      [
                        "14282809"
                      ],
                      [
                        "15458919"
                      ],
                      [
                        "16635029"
                      ],
                      [
                        "17811139"
                      ]
                      ]
                      
                  }
              }

          ]
      }'

  DMSReplicationTasknonparallelloadtables:
    Type: AWS::DMS::ReplicationTask
    Properties:
      MigrationType: "full-load-and-cdc"
      ReplicationInstanceArn: !Ref DMSReplicationInstance
      ReplicationTaskIdentifier: !Sub ${AWS::StackName}-${AWS::Region}-nonparallelloadtables
      SourceEndpointArn: !Ref OracleSourceEndpoint
      TargetEndpointArn: !Ref DMSAuroraPostgreSQLTargetEndpoint
      ReplicationTaskSettings: '{
                          "TargetMetadata":
                          {
                              "TargetSchema": "",
                              "SupportLobs": true,
                              "FullLobMode": false,
                              "LobChunkSize": 64,
                              "LimitedSizeLobMode": true,
                              "LobMaxSize": 32,
                              "InlineLobMaxSize": 0,
                              "LoadMaxFileSize": 0,
                              "ParallelLoadThreads": 0,
                              "ParallelLoadBufferSize": 0,
                              "BatchApplyEnabled": false,
                              "TaskRecoveryTableEnabled": false,
                              "ParallelLoadQueuesPerThread": 0,
                              "ParallelApplyThreads": 0,
                              "ParallelApplyBufferSize": 0,
                              "ParallelApplyQueuesPerThread": 0
                          },
                          "FullLoadSettings":
                          {
                              "CreatePkAfterFullLoad": false,
                              "StopTaskCachedChangesApplied": false,
                              "StopTaskCachedChangesNotApplied": false,
                              "MaxFullLoadSubTasks": 8,
                              "TransactionConsistencyTimeout": 600,
                              "CommitRate": 10000
                          },
                          "Logging":
                          {
                              "EnableLogging": true,
                              "EnableLogContext": true,
                              "LogComponents":
                              [
                                  {
                                      "Id": "SOURCE_UNLOAD",
                                      "Severity": "LOGGER_SEVERITY_DEFAULT"
                                  },
                                  {
                                      "Id": "SOURCE_CAPTURE",
                                      "Severity": "LOGGER_SEVERITY_DEFAULT"
                                  },
                                  {
                                      "Id": "TARGET_LOAD",
                                      "Severity": "LOGGER_SEVERITY_DEFAULT"
                                  },
                                  {
                                      "Id": "TARGET_APPLY",
                                      "Severity": "LOGGER_SEVERITY_DEFAULT"
                                  },
                                  {
                                      "Id": "TASK_MANAGER",
                                      "Severity": "LOGGER_SEVERITY_DEFAULT"
                                  }
                              ],
                              "CloudWatchLogGroup": null,
                              "CloudWatchLogStream": null
                          },
                          "ControlTablesSettings":
                          {
                              "ControlSchema": "",
                              "HistoryTimeslotInMinutes": 5,
                              "HistoryTableEnabled": false,
                              "SuspendedTablesTableEnabled": false,
                              "StatusTableEnabled": false
                          },
                          "StreamBufferSettings":
                          {
                              "StreamBufferCount": 3,
                              "StreamBufferSizeInMB": 8,
                              "CtrlStreamBufferSizeInMB": 5
                          },
                          "ChangeProcessingDdlHandlingPolicy":
                          {
                              "HandleSourceTableDropped": true,
                              "HandleSourceTableTruncated": true,
                              "HandleSourceTableAltered": true
                          },
                          "ErrorBehavior":
                          {
                              "DataErrorPolicy": "LOG_ERROR",
                              "DataTruncationErrorPolicy": "LOG_ERROR",
                              "DataErrorEscalationPolicy": "SUSPEND_TABLE",
                              "DataErrorEscalationCount": 0,
                              "TableErrorPolicy": "SUSPEND_TABLE",
                              "TableErrorEscalationPolicy": "STOP_TASK",
                              "TableErrorEscalationCount": 0,
                              "RecoverableErrorCount": -1,
                              "RecoverableErrorInterval": 5,
                              "RecoverableErrorThrottling": true,
                              "RecoverableErrorThrottlingMax": 1800,
                              "RecoverableErrorStopRetryAfterThrottlingMax": false,
                              "ApplyErrorDeletePolicy": "IGNORE_RECORD",
                              "ApplyErrorInsertPolicy": "LOG_ERROR",
                              "ApplyErrorUpdatePolicy": "LOG_ERROR",
                              "ApplyErrorEscalationPolicy": "LOG_ERROR",
                              "ApplyErrorEscalationCount": 0,
                              "ApplyErrorFailOnTruncationDdl": false,
                              "FullLoadIgnoreConflicts": true,
                              "FailOnTransactionConsistencyBreached": false,
                              "FailOnNoTablesCaptured": false
                          },
                          "ChangeProcessingTuning":
                          {
                              "BatchApplyPreserveTransaction": true,
                              "BatchApplyTimeoutMin": 1,
                              "BatchApplyTimeoutMax": 30,
                              "BatchApplyMemoryLimit": 500,
                              "BatchSplitSize": 0,
                              "MinTransactionSize": 1000,
                              "CommitTimeout": 1,
                              "MemoryLimitTotal": 1024,
                              "MemoryKeepTime": 60,
                              "StatementCacheSize": 50
                          },
                          "ValidationSettings":
                          {
                              "EnableValidation": false,
                              "ValidationMode": "ROW_LEVEL",
                              "ThreadCount": 5,
                              "FailureMaxCount": 10000,
                              "TableFailureMaxCount": 1000,
                              "HandleCollationDiff": false,
                              "ValidationOnly": false,
                              "RecordFailureDelayLimitInMinutes": 0,
                              "SkipLobColumns": false,
                              "ValidationPartialLobSize": 0,
                              "ValidationQueryCdcDelaySeconds": 0,
                              "PartitionSize": 10000
                          },
                          "PostProcessingRules": null,
                          "CharacterSetSettings": null,
                          "LoopbackPreventionSettings": null,
                          "BeforeImageSettings": null
                      }'
      TableMappings: '{
    "rules": [
        {
            "rule-type": "selection",
            "rule-id": "173959532",
            "rule-name": "173959532",
            "object-locator": {
                "schema-name": "DMS_SAMPLE",
                "table-name": "PRODUCT"
            },
            "rule-action": "include",
            "filters": []
        },
        {
            "rule-type": "selection",
            "rule-id": "173950644",
            "rule-name": "173950644",
            "object-locator": {
                "schema-name": "DMS_SAMPLE",
                "table-name": "EXPENSE"
            },
            "rule-action": "include",
            "filters": []
        },
        {
            "rule-type": "selection",
            "rule-id": "173940653",
            "rule-name": "173940653",
            "object-locator": {
                "schema-name": "DMS_SAMPLE",
                "table-name": "CLIENT"
            },
            "rule-action": "include",
            "filters": []
        },
        {
            "rule-type": "selection",
            "rule-id": "173932075",
            "rule-name": "173932075",
            "object-locator": {
                "schema-name": "DMS_SAMPLE",
                "table-name": "TECHNICIAN"
            },
            "rule-action": "include",
            "filters": []
        },
        {
            "rule-type": "selection",
            "rule-id": "173912142",
            "rule-name": "173912142",
            "object-locator": {
                "schema-name": "DMS_SAMPLE",
                "table-name": "LOCATION"
            },
            "rule-action": "include",
            "filters": []
        },
        {
            "rule-type": "selection",
            "rule-id": "173905290",
            "rule-name": "173905290",
            "object-locator": {
                "schema-name": "DMS_SAMPLE",
                "table-name": "ADDRESS"
            },
            "rule-action": "include",
            "filters": []
        },
        {
            "rule-type": "selection",
            "rule-id": "173896124",
            "rule-name": "173896124",
            "object-locator": {
                "schema-name": "DMS_SAMPLE",
                "table-name": "VENDOR"
            },
            "rule-action": "include",
            "filters": []
        },
        {
            "rule-type": "selection",
            "rule-id": "173887326",
            "rule-name": "173887326",
            "object-locator": {
                "schema-name": "DMS_SAMPLE",
                "table-name": "EXPENSE"
            },
            "rule-action": "include",
            "filters": []
        },
        {
            "rule-type": "selection",
            "rule-id": "173878603",
            "rule-name": "173878603",
            "object-locator": {
                "schema-name": "DMS_SAMPLE",
                "table-name": "EMPLOYEEPROJECT"
            },
            "rule-action": "include",
            "filters": []
        },
        {
            "rule-type": "selection",
            "rule-id": "173849514",
            "rule-name": "173849514",
            "object-locator": {
                "schema-name": "DMS_SAMPLE",
                "table-name": "DEPARTMENT"
            },
            "rule-action": "include",
            "filters": []
        },
        {
            "rule-type": "transformation",
            "rule-id": "173839812",
            "rule-name": "173839812",
            "rule-target": "column",
            "object-locator": {
                "schema-name": "%",
                "table-name": "%",
                "column-name": "%"
            },
            "rule-action": "convert-lowercase",
            "value": null,
            "old-value": null
        },
        {
            "rule-type": "transformation",
            "rule-id": "173834074",
            "rule-name": "173834074",
            "rule-target": "table",
            "object-locator": {
                "schema-name": "%",
                "table-name": "%"
            },
            "rule-action": "convert-lowercase",
            "value": null,
            "old-value": null
        },
        {
            "rule-type": "transformation",
            "rule-id": "173826674",
            "rule-name": "173826674",
            "rule-target": "schema",
            "object-locator": {
                "schema-name": "%"
            },
            "rule-action": "convert-lowercase",
            "value": null,
            "old-value": null
        },
        {
            "rule-type": "selection",
            "rule-id": "173783557",
            "rule-name": "173783557",
            "object-locator": {
                "schema-name": "DMS_SAMPLE",
                "table-name": "PRODUCT"
            },
            "rule-action": "include",
            "filters": []
        }
    ]
}'


#Create VPC Resources
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: !Ref VPCCIDR
      EnableDnsSupport: true
      EnableDnsHostnames: true
  
  InternetGateway:
    Type: AWS::EC2::InternetGateway

  InternetGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      InternetGatewayId: !Ref InternetGateway
      VpcId: !Ref VPC

  PublicSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select [ 0, !GetAZs '' ]
      CidrBlock: !Ref PublicSubnet1CIDR
      MapPublicIpOnLaunch: true
  
  PrivateSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select [ 0, !GetAZs  '' ]
      CidrBlock: !Ref PrivateSubnet1CIDR
      MapPublicIpOnLaunch: false
    
  PrivateSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select [ 1, !GetAZs  '' ]
      CidrBlock: !Ref PrivateSubnet2CIDR
      MapPublicIpOnLaunch: false

  NatGateway1EIP:
    Type: AWS::EC2::EIP
    DependsOn: InternetGatewayAttachment
    Properties:
      Domain: vpc

  NatGateway1:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt NatGateway1EIP.AllocationId
      SubnetId: !Ref PublicSubnet1

  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC

  DefaultPublicRoute:
    Type: AWS::EC2::Route
    DependsOn: InternetGatewayAttachment
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  PublicSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PublicRouteTable
      SubnetId: !Ref PublicSubnet1

  PrivateRouteTable1:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC

  DefaultPrivateRoute1:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTable1
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NatGateway1

  PrivateSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PrivateRouteTable1
      SubnetId: !Ref PrivateSubnet1

  PrivateRouteTable2:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC

  DefaultPrivateRoute2:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTable2
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NatGateway1

  PrivateSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PrivateRouteTable2
      SubnetId: !Ref PrivateSubnet2
  
  SecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security Group
      VpcId: !Ref VPC
  
  SecurityGroupIngressRules1:
    Type: AWS::EC2::SecurityGroupIngress    
    Properties:
      Description: Self referencing Security group rule
      GroupId: !Ref SecurityGroup
      IpProtocol: "tcp"
      FromPort: 0
      ToPort: 65535
      SourceSecurityGroupId: !Ref SecurityGroup

  SecurityGroupIngressRules2:
    Type: AWS::EC2::SecurityGroupIngress    
    Properties:
      Description: To allow all resources to communicate within VPC
      GroupId: !Ref SecurityGroup
      IpProtocol: "tcp"
      FromPort: 0
      ToPort: 65535
      CidrIp: !Ref VPCCIDR

  SecurityGroupEgressRules1:
    Type: AWS::EC2::SecurityGroupEgress    
    Properties:
      Description: To allow all resources to communicate within VPC
      GroupId: !Ref SecurityGroup
      IpProtocol: "tcp"
      FromPort: 0
      ToPort: 65535
      CidrIp: 0.0.0.0/0
  
  


#Outputs 
Outputs:
  vpcId:
    Description: VPC for all the Resources
    Value: !Ref VPC
  SecurityGroup:
    Description: Security Group to manage all resources
    Value: !Ref SecurityGroup
  RDSOracleSourceInstance:
    Description: RDS Oracle instance serving as source for DMS
    Value: !GetAtt OracleSourceInstance.Endpoint.Address
  OracleSecret:
    Description: Database Credentials Secret for RDS Oracle instance serving as source for DMS
    Value: !Ref OracleSecret
  RDSOracleSubnetGroup: 
    Description: Subnet group for RDS Oracle Source serving as source for DMS
    Value: !Ref RDSOracleSubnetGroup
  AuroraPostgreSQLTargetCluster:
    Description: Aurora PostgreSQL Cluster serving as Target for DMS
    Value: !GetAtt AuroraPostgreSQLTargetCluster.Endpoint.Address
  AuroraPostgreSQLTargetSecret:
    Description: Database Credentials Secret for Aurora PostgreSQL cluster serving as Target for DMS
    Value: !Ref AuroraPostgreSQLTargetSecret
  AuroraPostgreSQLTargetSubnetGroup:
    Description: Subnet group for Aurora PostgreSQL cluster serving as Target for DMS
    Value: !Ref AuroraPostgreSQLTargetSubnetGroup
  LinuxEC2Instance:
    Description: Linux EC2 instance to connect to RDS Resources
    Value: !Ref LinuxEC2Instance
  S3BucketDMS:
    Description: "S3 bucket for DMS Premigration assessments "
    Value: !Ref S3BucketDMS
